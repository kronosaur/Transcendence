<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

	<Sovereign UNID="&svAresHeretic;"
			name="Ares Sect"
			alignment="destructive order"
			>
		<Relationships>
			<Relationship sovereign="&svAres;" disposition="friend" mutual="true"/>
			<Relationship sovereign="&svPlayer;" disposition="neutral" mutual="true"/>
			<Relationship sovereign="&svFriendlyAuton;" disposition="neutral" mutual="true"/>
			<Relationship sovereign="&svCommonwealth;" disposition="neutral" mutual="true"/>
			<Relationship sovereign="&svCorporate;" disposition="neutral" mutual="true"/>
			<Relationship sovereign="&svIndependent;" disposition="neutral" mutual="true"/>
			<Relationship sovereign="&svIocrym;" disposition="enemy" mutual="true"/>
		</Relationships>
	</Sovereign>

	<Sovereign UNID="&svSentinelAI;"
			name="sentinel AI"
			alignment="constructive chaos"
			>
		<Relationships>
			<Relationship sovereign="&svIocrym;" disposition="friend" mutual="true"/>
		</Relationships>
	</Sovereign>

<!-- LEVEL XV ITEMS -->

	<!-- Iocrym Manipulator Device -->

	<ItemType UNID="&itIocrymManipulator;"
			name=				"Iocrym manipulator"
			virtual=			"true"
			>

		<Weapon
				type=				"missile"

				damage=				"graviton:6d12; WMD7"
				fireRate=			"15"
				missileSpeed=		"50"
				lifetime=			"60"
				hitPoints=			"30"
				powerUse=			"2000"

				sound=				"&snRecoillessCannon;"
				>

			<Effect>
				<SmokeTrail
						spread=			"0"
						emitDuration=	"100"
						emitRate=		"0-3"
						emitSpeed=		"12"
						particleLifetime="15"
						>
					<ParticleEffect>
						<Particle
								style=			"plain"
								minWidth=		"2"
								maxWidth=		"4"
								primaryColor=	"0xff, 0xc0, 0xff"
								secondaryColor=	"0xff, 0x80, 0xff"
								/>
					</ParticleEffect>
				</SmokeTrail>

				<Starburst
						style=			"flare"
						spikeCount=		"8"
						spikeLength=	"8-15"
						primaryColor=	"0xff, 0xc0, 0xff"
						secondaryColor=	"0xff, 0x80, 0xff"
						/>
			</Effect>

			<HitEffect>
				<Null/>
			</HitEffect>
		</Weapon>
	</ItemType>

	<!-- Stargate Control Rod -->

	<ItemType UNID="&itStargateControlRod;"
			name=				"stargate control rod"
			level=				"15"
			value=				"5000"
			mass=				"100"
			frequency=			"notrandom"
			numberAppearing=	"1"
			unknownType=		"&itUnknownHyperglyph;"
			attributes=			"Alien; HereticStargate; HyperglyphRod; MinorItem; NotForSale"

			description=		"This hyperglyph rod is used to program stargates."
			>

		<Image imageID="&rsHereticItems;" imageX="0" imageY="0" imageWidth="96" imageHeight="96"/>

		<Events>
			<OnObjDestroyed>
				(if (eq gSource aObjDestroyed)
				
					; If our object gets destroyed and we don't end up on the
					; resulting wreck, then we create our own object.
					
					(if (or (not aWreckObj) (not (objGetItems aWreckObj "* +unid:&itStargateControlRod;")))
						(block (theObj)
							(setq theObj (sysCreateFlotsam &itStargateControlRod; (objGetPos gSource) &svIndependent;))
							(objIncVel theObj (sysVectorPolarVelocity (random 0 359) 5))
							)
						)
					)
			</OnObjDestroyed>
		</Events>
	</ItemType>

<!-- LEVEL XII ITEMS -->

	<!-- Iocrym Cybernetic Tower -->

	<ItemType UNID="&itIocrymCyberneticTower;"
			name=				"Iocrym cybernetic tower"
			level=				"12"
			value=				"100000"
			mass=				"10000"
			frequency=			"notrandom"
			numberAppearing=	"1"
			attributes=			"Alien; IocrymCyberneticTower; NotForSale"

			description=		"This massive and beautiful crystalline tower is clearly part of a larger structure."
			>

		<Image imageID="&rsHereticItems;" imageX="96" imageY="0" imageWidth="96" imageHeight="96"/>
	</ItemType>
	
<!-- LEVEL X ITEMS -->

	<!-- Iocrym paralysis program -->

	<ItemType UNID="&itIocrymSentinelVirus;"
			name=				"Iocrym sentinel virus(es)"
			level=				"10"
			value=				"2500"
			mass=				"50"
			frequency=			"notrandom"
			unknownType=		"&itUnknownMnemonicCube;"
			attributes=			"Consumable; Info; NotForSale"

			description=		"This cube contains an infiltrator virus that will disable Iocrym sentinels within 50 light-seconds."
			>

		<Image imageID="&rsItems1;" imageX="192" imageY="288" imageWidth="96" imageHeight="96"/>

		<Invoke key="V">
			(switch
				; If we don't have a quantum CPU
				(not (objGetItems gSource "*I+QuantumCPU"))
					(objSendMessage gSource Nil "Quantum CPU required")

				; Otherwise, we disable any Iocrym sentinels
				(block (targets)
					(setq targets (sysFindObject gSource "sN:50; +iocrymSentinel;"))
					(enum targets target
						(objMakeParalyzed target (random 9000 15000))
						)
					(if targets
						(objSendMessage gSource Nil "ISV0.9b: Program complete")
						(objSendMessage gSource Nil "ISV0.9b: No target signal")
						)

					(itmSetKnown gItem)
					(objRemoveItem gSource gItem 1)
					)
				)
		</Invoke>
	</ItemType>

<!-- LEVEL V ITEMS -->

	<!-- MRAD experiment

	GLOBAL DATA

	probe{1-6}:			The ObjID of the probes. 0 = not yet deployed.

	probeCount:			Number of probes deployed

	status:				Status of experiment:
							Nil =				No results yet
							'found =			Anomaly found
							'complete =			Data ROM handed to player
							'failed =			All probes deployed, anomaly not found
							'baseDestroyed =	Base was destroyed; experiment failed

	-->

	<ItemType UNID="&itMRADExperiment;"
			name=				"MRAD experiment"
			level=				"5"
			value=				"15000"
			mass=				"2000"
			frequency=			"notrandom"
			attributes=			"MajorItem; MRADExperiment; NotForSale"

			charges=			"6"

			description=		"The MRAD device is designed to detect and study magnetic energy."

			useScreen=			"Main"
			useKey=				"X"
			useInstalledOnly=	"true"
			>

		<Image imageID="&rsItems1;" imageX="0" imageY="192" imageWidth="96" imageHeight="96"/>

		<MiscellaneousDevice
				powerUse=		"500"
				/>

		<DockScreens>
			<Main 
				name=			"MRAD Experiment"
				backgroundID=	"none"
				>

				<Display>
					<OnDisplayInit>
						(block Nil
							; Set the variables for all the probes
							(for i 1 6
								(set (cat "MRADProbe" i)
									(objGetObjByID (typGetGlobalData &itMRADExperiment; (cat "probe" i)))
									)
								)

							; Set variable for anomaly pos
							(setq MRADAnomalyPos (typGetGlobalData &stCommonwealthResearchHeretic; "anomalyPos"))
							)
					</OnDisplayInit>

					<Group left="12" top="12" width="182" height="172">
						<Image transparent="true">
							(resCreateImageDesc &rsMRADConsole; 0 (if MRADProbe1 0 172) 182 172)
						</Image>

						<Text left="10" top="4" font="LargeBold" color="0,0,0">
							"Probe 1"
						</Text>

						<Text left="12" top="50" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe1 MRADAnomalyPos 'shipDistance)
						</Text>

						<Text left="12" top="84" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe1 MRADAnomalyPos 'shipBearing)
						</Text>

						<Text right="-12" top="50" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe1 MRADAnomalyPos 'anomalyDistance)
						</Text>

						<Text right="-12" top="84" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe1 MRADAnomalyPos 'anomalyBearing)
						</Text>

						<Text right="-12" top="118" align="right" font="LargeBold" color="242,101,34">
							(mradDisplay MRADProbe1 MRADAnomalyPos 'dataDownload)
						</Text>
					</Group>

					<Group center="0" top="12" width="182" height="172">
						<Image transparent="true">
							(list &rsMRADConsole; 0 (if MRADProbe2 0 172) 182 172)
						</Image>

						<Text left="10" top="4" font="LargeBold" color="0,0,0">
							"Probe 2"
						</Text>

						<Text left="12" top="50" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe2 MRADAnomalyPos 'shipDistance)
						</Text>

						<Text left="12" top="84" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe2 MRADAnomalyPos 'shipBearing)
						</Text>

						<Text right="-12" top="50" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe2 MRADAnomalyPos 'anomalyDistance)
						</Text>

						<Text right="-12" top="84" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe2 MRADAnomalyPos 'anomalyBearing)
						</Text>

						<Text right="-12" top="118" align="right" font="LargeBold" color="242,101,34">
							(mradDisplay MRADProbe2 MRADAnomalyPos 'dataDownload)
						</Text>
					</Group>

					<Group right="-12" top="12" width="182" height="172">
						<Image transparent="true">
							(list &rsMRADConsole; 0 (if MRADProbe3 0 172) 182 172)
						</Image>

						<Text left="10" top="4" font="LargeBold" color="0,0,0">
							"Probe 3"
						</Text>

						<Text left="12" top="50" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe3 MRADAnomalyPos 'shipDistance)
						</Text>

						<Text left="12" top="84" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe3 MRADAnomalyPos 'shipBearing)
						</Text>

						<Text right="-12" top="50" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe3 MRADAnomalyPos 'anomalyDistance)
						</Text>

						<Text right="-12" top="84" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe3 MRADAnomalyPos 'anomalyBearing)
						</Text>

						<Text right="-12" top="118" align="right" font="LargeBold" color="242,101,34">
							(mradDisplay MRADProbe3 MRADAnomalyPos 'dataDownload)
						</Text>
					</Group>

					<Group left="12" top="200" width="182" height="172">
						<Image transparent="true">
							(list &rsMRADConsole; 0 (if MRADProbe4 0 172) 182 172)
						</Image>

						<Text left="10" top="4" font="LargeBold" color="0,0,0">
							"Probe 4"
						</Text>

						<Text left="12" top="50" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe4 MRADAnomalyPos 'shipDistance)
						</Text>

						<Text left="12" top="84" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe4 MRADAnomalyPos 'shipBearing)
						</Text>

						<Text right="-12" top="50" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe4 MRADAnomalyPos 'anomalyDistance)
						</Text>

						<Text right="-12" top="84" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe4 MRADAnomalyPos 'anomalyBearing)
						</Text>

						<Text right="-12" top="118" align="right" font="LargeBold" color="242,101,34">
							(mradDisplay MRADProbe4 MRADAnomalyPos 'dataDownload)
						</Text>
					</Group>

					<Group center="0" top="200" width="182" height="172">
						<Image transparent="true">
							(list &rsMRADConsole; 0 (if MRADProbe5 0 172) 182 172)
						</Image>

						<Text left="10" top="4" font="LargeBold" color="0,0,0">
							"Probe 5"
						</Text>

						<Text left="12" top="50" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe5 MRADAnomalyPos 'shipDistance)
						</Text>

						<Text left="12" top="84" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe5 MRADAnomalyPos 'shipBearing)
						</Text>

						<Text right="-12" top="50" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe5 MRADAnomalyPos 'anomalyDistance)
						</Text>

						<Text right="-12" top="84" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe5 MRADAnomalyPos 'anomalyBearing)
						</Text>

						<Text right="-12" top="118" align="right" font="LargeBold" color="242,101,34">
							(mradDisplay MRADProbe5 MRADAnomalyPos 'dataDownload)
						</Text>
					</Group>

					<Group right="-12" top="200" width="182" height="172">
						<Image transparent="true">
							(list &rsMRADConsole; 0 (if MRADProbe6 0 172) 182 172)
						</Image>

						<Text left="10" top="4" font="LargeBold" color="0,0,0">
							"Probe 6"
						</Text>

						<Text left="12" top="50" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe6 MRADAnomalyPos 'shipDistance)
						</Text>

						<Text left="12" top="84" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe6 MRADAnomalyPos 'shipBearing)
						</Text>

						<Text right="-12" top="50" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe6 MRADAnomalyPos 'anomalyDistance)
						</Text>

						<Text right="-12" top="84" align="right" font="MediumHeavyBold" color="255,255,255">
							(mradDisplay MRADProbe6 MRADAnomalyPos 'anomalyBearing)
						</Text>

						<Text right="-12" top="118" align="right" font="LargeBold" color="242,101,34">
							(mradDisplay MRADProbe6 MRADAnomalyPos 'dataDownload)
						</Text>
					</Group>
				</Display>

				<Panes>
					<Default>
						<OnPaneInit>
							(block (status)
								(setq status (typGetGlobalData &itMRADExperiment; "status"))

								(switch
									(eq status 'found)
										(scrSetDesc gScreen
											"Anomaly located.\n"
											"MRAD probe data download complete.\n"
											"MRAD experiment complete.\n\n"
											"Return to base station for data analysis."
											)

									(eq status 'failed)
										(scrSetDesc gScreen
											"All MRAD probes launched.\n"
											"Anomaly not located.\n"
											"MRAD experiment failed."
											)

									(eq status 'baseDestroyed)
										(scrSetDesc gScreen
											"Base station destroyed.\n"
											"Anomaly data lost.\n"
											"MRAD experiment failed."
											)
											
									(scrSetDesc gScreen
										"MRAD experiment online.\n\n"
										"You must deploy a probe within 10 light-seconds of the anomaly to gather data "
										"and to successfully complete the experiment.\n\n"
										(switch
											(eq (itmGetCharges gItem) 1)
												"You have 1 probe left."
											(eq (itmGetCharges gItem) 6)
												"You have 6 probes left. Deploy a probe to begin the experiment."
											(cat "You have " (itmGetCharges gItem) " probes left. Deploy a probe to continue the experiment.")
											)
										)
									)

								; Deploy probe command only available if probes left
								(scrEnableAction gScreen 0 
									(and (not status) (gr (itmGetCharges gItem) 0))
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Deploy Probe" default="1" key="D">
								(block (theProbe probeNumber probeDist)
									(setq probeNumber (typIncGlobalData &itMRADExperiment; "probeCount"))

									; Deploy the probe
									(setq theProbe (sysCreateStation &stMRADSensor; (sysVectorPolarOffset gSource (random 0 359) 1)))
									(objSetName theProbe (cat "MRAD Probe " probeNumber) 0x40)
									(typSetGlobalData &itMRADExperiment; (cat "probe" probeNumber) (objGetID theProbe))
									(objSetKnown theProbe)
									(objSetShowAsDestination theProbe True)

									; Consume charges
									(setq gItem (objIncItemCharges gSource gItem -1))

									; How far are we from the anomaly?
									(setq probeDist 
										(sysVectorDistance (typGetGlobalData &stCommonwealthResearchHeretic; "anomalyPos") theProbe)
										)

									; Determine result
									(switch
										; If we're close, then we found it
										(leq probeDist 10)
											(block Nil
												(typSetGlobalData &itMRADExperiment; "status" 'found)
												(scrShowPane gScreen "ProbeLaunchedFound")
												)

										; If this was our last probe, then we fail
										(eq (itmGetCharges gItem) 0)
											(block Nil
												(typSetGlobalData &itMRADExperiment; "status" 'failed)
												(scrShowPane gScreen "Default")
												)

										; Keep looking
										(scrShowPane gScreen "ProbeLaunched")
										)
									)
							</Action>

							<Action name="Done" cancel="1" key="n">
								(scrExitDock gScreen)
							</Action>
						</Actions>
					</Default>

					<ProbeLaunched>
						<OnPaneInit>
							(block (theProbe probeDist anomalyPos)
								(setq theProbe 
									(objGetObjByID 
										(typGetGlobalData &itMRADExperiment; (cat "probe" (typGetGlobalData &itMRADExperiment; "probeCount")))
										)
									)
									
								(setq anomalyPos (typGetGlobalData &stCommonwealthResearchHeretic; "anomalyPos"))
								(setq probeDist (sysVectorDistance anomalyPos theProbe))

								(switch
									(not theProbe)
										(scrSetDesc gScreen "Probe destroyed.")
										
									(leq probeDist 75)
										(scrSetDesc gScreen 
											"Probe launched.\n\n"
											"Anomaly detected "	probeDist " light-seconds away. "
											"Bearing to anomaly established at "
											(modulo (add 90 (subtract 360 (sysVectorAngle (sysVectorSubtract anomalyPos theProbe)))) 360)
											" degrees from probe.\n\n"
											"Move ship to proper position relative to probe and drop another probe."
											)
											
									(leq probeDist 500)
										(scrSetDesc gScreen 
											"Probe launched.\n\n"
											"Anomaly detected "	probeDist " light-seconds away from probe.\n\n"
											"Move ship to new position at given distance and drop another probe."
											)
											
									(scrSetDesc gScreen
										"Probe launched.\n\n"
										"No anomaly detected within 500 light-seconds of probe.\n\n"
										"Move ship to a new position and drop another probe."
										)
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</ProbeLaunched>

					<ProbeLaunchedFound>
						<OnPaneInit>
							(scrSetDesc gScreen
								"Probe launched.\n\n"
								"Graviton anomaly detected within 10 light-seconds.\n"
								"Downloading data from probe..."
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</ProbeLaunchedFound>
				</Panes>
			</Main>
		</DockScreens>
	</ItemType>

<!-- LEVEL I ITEMS -->

	<ItemType UNID="&itHereticResearchROM;"
			name=				"data ROM(s) labeled &quot;Heretic research&quot;"
			level=				"1"
			value=				"0"
			mass=				"1"
			frequency=			"notrandom"
			attributes=			"HereticROM; Info; MinorItem; NotForSale"

			description=		"This ROM contains research data about Iocrym technology."
			>

		<Image imageID="&rsItems1;" imageX="192" imageY="96" imageWidth="96" imageHeight="96"/>

	</ItemType>

	<ItemType UNID="&itIocrymSentinelData;"
			name=				"data ROM(s) labeled &quot;Heretic research&quot;"
			level=				"1"
			value=				"0"
			mass=				"1"
			frequency=			"notrandom"
			attributes=			"HereticROM; Info; MinorItem; NotForSale; LesserData"

			description=		"This ROM contains research data about Iocrym technology."
			>

		<Image imageID="&rsItems1;" imageX="192" imageY="96" imageWidth="96" imageHeight="96"/>

	</ItemType>

<!-- SHIPS -->

	<!-- Huygens Explorer -->

	<ShipClass UNID="&scHuygensExplorer;"
			manufacturer=		"Ringers"
			class=				"Huygens"
			type=				"explorer"
			defaultSovereign=	"&svRingers;"

			size=				"195"
			mass=				"4000"
			cargoSpace=			"1500"
			thrustRatio=		"0.8"
			maxSpeed=			"12"

			explosionType=		"&vtThermoExplosion2;"

			attributes=			"capitalShip, genericClass, huygensExplorer, majorShip, ringers"

			dockingPorts=		"4"
			dockScreen=			"Main"
			>

		<Armor
			armorID=			"&itQuadroCarbideArmor;"
			count=				"24"
			/>
		
		<Devices>
			<Device deviceID="&itMammoth100Deflector;"/>

			<Device deviceID="&itPositronLancer;" minFireArc="30" maxFireArc="175" posAngle="90" posRadius="5"/>
			<Device deviceID="&itPositronLancer;" minFireArc="185" maxFireArc="330" posAngle="270" posRadius="5"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"5"
			rotationAccel=		"0.5"
			/>

		<Interior>
			<Compartment name="interior"
					hitPoints=	"120"
					/>
			
			<Compartment name="main drive"
					type=		"mainDrive"
					hitPoints=	"80"

					posX=		"-61"
					posY=		"0"
					sizeX=		"60"
					sizeY=		"40"
					/>
		</Interior>
		
		<Items>
			<Item count="1" item="&itHereticResearchROM;"/>
		</Items>

		<Image imageID="&rsCorporateExplorer;" imageWidth="192" imageHeight="192" />

		<Effects>
			<Effect type="thrustMain"		posAngle="176"	posRadius="88"	posZ="0"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="-176"	posRadius="88"	posZ="0"	rotation="180"	effect="&efMainThrusterLarge;"/>
		</Effects>
		
		<Names definiteArticle="true">Huygens Explorer</Names>

		<Events>
			<OnAttacked>
				(if (and (eq aOrderGiver gPlayerShip)
						(eq (shpGetOrder gSource) 'hold))
					(block Nil
						(sovSetDisposition &svSentinelAI; &svPlayer; 0)
						(sovSetDisposition &svPlayer; &svSentinelAI; 0)

						(shpCancelOrders gSource)
						(shpOrder gSource 'attack gPlayerShip)
						)
					)
			</OnAttacked>
			
			<OnDestroy>
				(shpCancelOrders gPlayerShip)
			</OnDestroy>

			<OnOrdersCompleted>
				(block Nil
					(shpOrder gSource 'waitForEnemy)
					(shpOrder gSource 'attackNearestEnemy)
					)
			</OnOrdersCompleted>
		</Events>

		<DockScreens>
			<Main>
				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"You dock with the Huygens Explorer, but the airlock reports zero pressure "
								"inside. Peering in through the airlock window you see floating bodies and debris.\n\n"
								"Suddenly you feel the Huygens's engines kick into action. "
								"Your stomach fills with dread..."
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								(block Nil
									(sovSetDisposition &svSentinelAI; &svPlayer; 0)
									(sovSetDisposition &svPlayer; &svSentinelAI; 0)

									(shpCancelOrders gSource)
									(shpOrder gSource 'attack gPlayerShip)

									(scrExitDock gScreen)
									)
							</Action>
						</Actions>
					</Default>
				</Panes>
			</Main>
		</DockScreens>

		<AISettings
			fireRateAdj=		"15"
			fireAccuracy=		"95"
			perception=			"8"
			/>

	</ShipClass>

	<!-- Svalbard explorer

	GLOBAL DATA

	controlPointCamp:	If True, then scientists from the Svalbard Explorer have set up
						a camp at the Iocrym control point.

	missionsLeft:		Number of missions to be completed. This is decremented when the player
						completes a mission or when a station giving the mission is destroyed.
						If this number + researchStatus is less than 3, then the player is stuck
						and the quarantine will never be lifted.

	missionSvalbard:	If True, Svalbard has completed its survey of manipulators

	researchStatus:		This is a counter that is incremented each time that we discover
						some important information. When the counter reaches 3 then we can
						disable the Iocrym manipulators.

	inTransfer:			If True, the Svalbard team and equipment are being transferred to the
						control point by the player.

	EXTRA DATA

	status:				Status of the ship
							Nil						= Player has not yet met the ship
							'goingToExplore			= Ship is heading towards manipulator orbit
							'exploring				= Ship is exploring the manipulators
							'outOfFuel				= Ship ran out of fuel (prevStatus is old status)
							'doneExploring			= Ship has completed survey of manipulators
							'dockAtControlPoint		= Ship is on its way to control point
							'campEstablished		= Ship is docked at control point

	timer:				Decrementing timer

	-->

	<ShipClass UNID="&scSvalbardExplorer;"
			manufacturer=		"Corporate"
			class=				""
			type=				"explorer"
			defaultSovereign=	"&svCorporate;"

			size=				"195"
			mass=				"4000"
			cargoSpace=			"1000"
			thrustRatio=		"1.2"
			maxSpeed=			"10"

			cyberDefenseLevel=	"8"

			explosionType=		"&vtThermoExplosion2;"
			wreckType=			"&stSvalbardWreck;"

			attributes=			"capitalShip, corporate, genericClass, majorShip, svalbardExplorer, uncharted"

			dockingPorts=		"4"
			dockScreen=			"Main"
			>

		<Armor>
			<ArmorSection start="345" span="15" armorID="&itQuadroCarbideArmor;" />
			<ArmorSection start="330" span="15" armorID="&itQuadroCarbideArmor;" />
			<ArmorSection start="315" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="300" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="285" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="270" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="255" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="240" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="225" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="210" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="195" span="15" armorID="&itQuadroCarbideArmor;" />
			<ArmorSection start="180" span="15" armorID="&itQuadroCarbideArmor;" />

			<ArmorSection start="165" span="15" armorID="&itQuadroCarbideArmor;" />
			<ArmorSection start="150" span="15" armorID="&itQuadroCarbideArmor;" />
			<ArmorSection start="135" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="120" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="105" span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="90"  span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="75"  span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="60"  span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="45"  span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="30"  span="15" armorID="&itQuadroCarbideArmor;" nonCritical="general"/>
			<ArmorSection start="15"  span="15" armorID="&itQuadroCarbideArmor;" />
			<ArmorSection start="0"   span="15" armorID="&itQuadroCarbideArmor;" />
		</Armor>

		<Devices>
			<Device deviceID="&itPlasmaShieldGenerator;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"3"
			rotationAccel=		"0.5"
			/>
		
		<Interior>
			<Compartment name="interior"
					hitPoints=	"120"
					/>
			
			<Compartment name="main drive"
					type=		"mainDrive"
					hitPoints=	"80"

					posX=		"-61"
					posY=		"0"
					sizeX=		"60"
					sizeY=		"40"
					/>
		</Interior>

		<Items>
			<Item count="2d12" item="&itPteracniumFuelRod;"/>
		</Items>

		<Image imageID="&rsCorporateExplorer;" imageWidth="192" imageHeight="192" />

		<Effects>
			<Effect type="thrustMain"		posAngle="176"	posRadius="88"	posZ="0"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="-176"	posRadius="88"	posZ="0"	rotation="180"	effect="&efMainThrusterLarge;"/>
		</Effects>
		
		<Names definiteArticle="true">Svalbard Explorer</Names>

		<AISettings
			fireRateAdj=		"25"
			fireAccuracy=		"95"
			perception=			"4"
			/>

		<Events>
			<OnBehavior>
				(block (status)
					(setq status (objGetData gSource "status"))
					(switch
						(eq status 'goingToExplore)
							(if (leq (sysVectorDistance (objGetPos gSource)) 65)
								(block Nil
									(objSendMessage gPlayerShip gSource "The Iocrym are altering the Heretic sun!")
									(objSetData gSource "status" 'exploring)
									(objSetData gSource "timer" 120)
									)
								)

						(eq status 'exploring)
							(block (timer)
								(setq timer (objIncData gSource "timer" -1))
								(switch
									(leq timer 0)
										(block Nil
											(shpCancelOrders gSource)
											(shpOrder gSource 'hold)
											(objSetData gSource "status" 'doneExploring)
											
											(herStatusClear 'currentMission)
											(herStatusSet 'missionSvalbard 'success)
											
											(objSendMessage gPlayerShip gSource "Mission complete!")
											)

									(eq (modulo timer 9) 0)
										(objSendMessage gPlayerShip gSource "Scanning...")
									)
								)

						(eq status 'dockAtControlPoint)
							(if (objIsDockedAt gSource (sysFindObject gSource "TN +hereticControlPoint"))
								(block Nil
									(herStatusSet 'controlPointCamp)
									(typIncGlobalData &scSvalbardExplorer; "researchStatus" 1)
									(herStatusSet 'missionSvalbardExplorer 'success)
									(typIncGlobalData &scSvalbardExplorer; "missionsLeft" -1)

									(objSetData gSource "status" 'campEstablished)
									(objSendMessage gPlayerShip gSource "Mission complete!")
									)
								)

						(eq status 'outOfFuel)
							; If we have fuel, then go back to exploring
							(if (objGetItems gSource "f")
								(block (prevStatus)
									(setq prevStatus (objGetData gSource "prevStatus"))
									(switch
										(eq prevStatus 'exploring)
											(block Nil
												(shpCancelOrders gSource)
												(shpOrder gSource 'orbit (sysFindObject Nil "tN +star;") 63)
												)

										(eq prevStatus 'dockAtControlPoint)
											(block Nil
												(shpCancelOrders gSource)
												(shpOrder gSource 'dock (sysFindObject gSource "TN +hereticControlPoint;"))
												)
										)

									(objSetData gSource "status" prevStatus)
									(objSendMessage gPlayerShip gSource "Fueled up and ready!")
									)
								)
						)

					; If we are out of fuel, then we stop
					(if (and (not (eq status 'campEstablished))
							(not (eq status 'outOfFuel))
							(not (objGetItems gSource "f")))
						(block Nil
							(objSetData gSource "prevStatus" status)

							(shpCancelOrders gSource)
							(shpOrder gSource 'hold)
							(objSetData gSource "status" 'outOfFuel)
							(objSendMessage gPlayerShip gSource "Pteravores have devoured our fuel!")
							)
						)
					)
			</OnBehavior>

			<OnCreate>
				(block Nil
					; Initialize some variables
					(objSetGlobalData gSource "missionsLeft" 5)
					(objSetGlobalData gSource "researchStatus" 0)

					; Behavior timer
					(sysAddObjRecurringTimerEvent 31 gSource "OnBehavior")
					)
			</OnCreate>

			<OnDamage>
				(block Nil
					(switch
						(objHasAttribute aAttacker "pteravore")
							(block Nil
								(objSendMessage gPlayerShip gSource "Pteravores!")
								)
						)

					aDamageHP
					)
			</OnDamage>
			
			<OnDestroy>
				(if (not (herStatus 'missionSvalbardExplorer))
					(herStatusSet 'missionSvalbardExplorer 'failure)
					)
			</OnDestroy>

			<OrderExplore>
				(block (shipPos shipAngle shipRadius)
					; Figure out ship's current location (in polar coordinates)
					(setq shipPos (objGetPos gSource))
					(setq shipAngle (sysVectorAngle shipPos))
					(setq shipRadius (sysVectorDistance shipPos))

					; Order the ship to go to the orbit of the manipulators
					(shpCancelOrders gSource)
					(shpOrder gSource 'orbit (sysFindObject Nil "tN +star;") 63)

					; Exploring
					(objSetData gSource "status" 'goingToExplore)
					(objSendMessage gPlayerShip gSource "Follow us!")
					)
			</OrderExplore>
		</Events>

		<DockScreens>
			<Main>
				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You are docked with the Svalbard Explorer."
								)
						</OnPaneInit>

						<Actions>
							<Action name="Bridge" default="1" key="B">
								(block (status)
									(setq status (objGetData gSource "status"))
									(switch
										(not status)
											(scrShowPane gScreen "Intro")

										(or (eq status 'goingToExplore) (eq status 'exploring))
											(scrShowPane gScreen "Exploring")

										(eq status 'outOfFuel)
											(scrShowPane gScreen "OutOfFuel")

										(eq status 'doneExploring)
											(scrShowPane gScreen "DoneExploring")

										(eq status 'dockAtControlPoint)
											(scrShowPane gScreen "EnRouteToControlPoint")

										(eq status 'campEstablished)
											(scrShowPane gScreen "CampEstablished")
										)
									)
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</Default>

					<Intro>
						<OnPaneInit>
							(block (statusKateM)
								(setq statusKateM (typGetGlobalData &svCorporate; "statusKateM"))
								(switch
									(eq statusKateM 'ally)
										(scrSetDesc gScreen
											"The bridge of the Svalbard hums with activity and you see a familiar face giving orders as you walk in. "
											"Kate Morgental is excited to see you:\n\n"
											"\"Hello, %name%! It's great to see you again. Welcome to the Svalbard! I knew that our paths would cross again. "
											"My father is gathering intelligence about the Iocrym and trying to understand why they have blocked our access to the "
											"rest of the galaxy. He's asked me to study them here in the Heretic system.\""
											)

									(or (eq statusKateM 'destroyed) (eq statusKateM 'destroyedByPlayer))
										(scrSetDesc gScreen
											"The bridge of the Svalbard hums with activity. You see Kate Morgental at the center of the bridge giving orders. "
											"A ripple of contempt flashes across her face as she sees you:\n\n"
											"%name%. I haven't forgotten what you did to me! But our work is too important to let emotions get in the way. "
											"My father wants to learn more about the Iocrym and he's asked me to study their technology here in the Heretic system.\""
											)

									(eq statusKateM 'betrayedKatami)
										(scrSetDesc gScreen
											"The bridge of the Svalbard hums with activity. You see Kate Morgental at the center of the bridge giving orders. "
											"A ripple of contempt flashes across her face as she sees you:\n\n"
											"%name%. I haven't forgotten what you did to Katami! But our work is too important to let emotions get in the way. "
											"My father wants to learn more about the Iocrym and he's asked me to study their technology here in the Heretic system.\""
											)
											
									(scrSetDesc gScreen
										"The bridge of the Svalbard hums with activity. An elegant woman is giving orders as you walk in. She turns to you:\n\n"
										"\"Welcome to the Svalbard! My name is Kate Morgental and I'm in charge of this research expedition. "
										"My father is gathering intelligence about the Iocrym and trying to understand why they have blocked our access to the rest "
										"of the galaxy. He's asked me to study them here in the Heretic system.\""
										)
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(scrShowPane gScreen "EscortMission")
							</Action>
						</Actions>
					</Intro>

					<EscortMission>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"\"The truth is that we need help. We want to scan the Iocrym structures that "
								"are surrounding the Heretic sun, but the area is infested with pteravores and "
								"we don't dare get too close without protection.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="&quot;I'll help you.&quot;" default="1" cancel="1" key="h">
								(scrShowPane gScreen "MissionAccepted")
							</Action>
						</Actions>
					</EscortMission>
					
					<MissionAccepted>
						<OnPaneInit>
							(switch
								(or (eq (typGetGlobalData &svCorporate; "statusKateM") 'betrayedKatami)
										(eq (typGetGlobalData &svCorporate; "statusKateM") 'destroyed)
										(eq (typGetGlobalData &svCorporate; "statusKateM") 'destroyedByPlayer))
									(scrSetDesc gScreen
										"\"Well, we don't have a choice; we'll have to trust you.\n\n"
										"Escort us while we do our scan and maybe your good deed will salve your conscience.\""
										)
										
								(scrSetDesc gScreen
									"\"I was hoping you'd say that! We're going to orbit around the Heretic sun to study the "
									"Iocrym devices. Follow us and protect us from pteravores. If they attach to our ship they will "
									"drain our reactor and we'll be helpless.\n\n"
									"\"Good luck!\""
									)
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								(block Nil
									(objFireEvent gSource "OrderExplore")
									(scrExitDock gScreen)
									)
							</Action>
						</Actions>
					</MissionAccepted>

					<Exploring>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"\"We're still scanning the Iocrym devices. No definitive results yet.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								(block Nil
									(scrExitDock gScreen)
									)
							</Action>
						</Actions>
					</Exploring>

					<DoneExploring>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"Kate looks exhausted, but pleased:\n\n"
								"\"Great work! We've finished our scan. "
								"The Iocrym devices are manipulating the graviton flux of the Heretic star. They "
								"have created an event horizon that prevents us from leaving the inner system.\n\n"
								"\"All of the Iocrym devices are controlled from a central point. If we set up a research base "
								"there we may be able to disable them! Follows us there and we'll see!\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								(block Nil
									(shpCancelOrders gSource)
									(shpOrder gSource 'dock (sysFindObject gSource "TN +hereticControlPoint"))
									(objSetData gSource "status" 'dockAtControlPoint)

									(scrExitDock gScreen)
									)
							</Action>
						</Actions>
					</DoneExploring>

					<EnRouteToControlPoint>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"\"Follow us to the Iocrym control point and maybe we can figure out a way "
								"to disable the Iocrym quarantine.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								(block Nil
									(scrExitDock gScreen)
									)
							</Action>
						</Actions>
					</EnRouteToControlPoint>

					<CampEstablished>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"The bridge of the Svalbard is almost deserted. A skeleton crew watches over a few "
								"instruments. A researcher shakes his head as you enter:\n\n"
								"\"If you're looking for Morgental she's with all the cool people inside the Iocrym control structure.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								(block Nil
									(scrExitDock gScreen)
									)
							</Action>
						</Actions>
					</CampEstablished>

					<OutOfFuel>
						<OnPaneInit>
							(scrSetDesc gScreen
								"The bridge is dim and almost silent. Kate Morgental approaches you:\n\n"
								"\"Pteravores have eaten all our fuel! We can't continue our research unless we get some "
								"pteracnium or even xenotite. Can you help us?\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="&quot;I can help.&quot;" default="1" key="h">
								(scrShowScreen gScreen "DonateFuel")
							</Action>

							<Action name="&quot;Sorry, I don't have any fuel.&quot;" cancel="1" key="S">
								(scrShowPane gScreen "GetFuel")
							</Action>
						</Actions>
					</OutOfFuel>

					<GetFuel>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"We can last for a while on emergency power, but if you can find some fuel and bring "
								"it here we will be able to continue our research.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</GetFuel>
				</Panes>
			</Main>

			<DonateFuel
					type=				"itemPicker"
					>
				
				<ListOptions
					dataFrom=	"player"
					list=		"f"
					/>

				<Panes>
					<Default>
						<OnPaneInit>
							(block Nil
								(setq gItem (scrGetItem gScreen))
								(setq gMaxCount (itmGetCount gItem))
								(scrSetDesc gScreen
									"Select the fuel that you wish to donate to the Svalbard."
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Donate this Item" default="1" key="D">
								(switch
									(gr gMaxCount 1)
										(scrShowPane gScreen "Quantity")

									(eq gMaxCount 1)
										(block Nil
											(setq gItem (scrRemoveItem gScreen 1))
											(objAddItem gSource gItem)
											(scrShowPane gScreen "Donate")
											)
									)
							</Action>

							<Action name="Leave" cancel="1" key="L">
								(scrShowScreen gScreen "Main" "GetFuel")
							</Action>
						</Actions>					
					</Default>

					<Quantity
							showCounter=	"true">

						<OnPaneInit>
							(block Nil
								(scrSetDesc gScreen 
									"How many " (itmGetName gItem 0x02) " do you wish to donate?"
									)
								(scrSetCounter gScreen gMaxCount)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Donate" default="1" key="D">
								(block (count)
									(setq count (scrGetCounter gScreen))
									(if (gr count gMaxCount)
										(scrSetCounter gScreen gMaxCount)
										(block Nil
											(setq gItem (scrRemoveItem gScreen count))
											(objAddItem gSource gItem)
											(scrShowPane gScreen "Donate")
											)
										)
									)
							</Action>

							<Action name="Cancel" cancel="1" key="C">
								<ShowPane pane="Default"/>
							</Action>

						</Actions>
					</Quantity>

					<Donate noListNavigation="true">
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Thanks, %name%! I knew we could count on you. My father will be very pleased "
								"that we can continue our research.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" cancel="1" default="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</Donate>
				</Panes>

			</DonateFuel>
		</DockScreens>

	</ShipClass>

<!-- STATIONS -->

	<!-- Heretic Station
	
	EXTRA DATA

	status:				Status of the station
							Nil						= Mission has not started yet
							'introDone				= Player has been told about the system
	-->

	<StationType UNID="&stHereticStation;"
			name=				"Heretic Station"
			sovereign=			"&svCommonwealth;"
			inherit=			"&baCommonwealthStation;"
				 
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			dockingPorts=		"8"
			canAttack=			"true"

			multiHull=			"true"
			armorID=			"&itP120HexphaseArmor;"
			hitPoints=			"350"
			repairRate=			"1"
			shipRepairRate=		"1"
			fireRateAdj=		"40"
			explosionType=		"&vtThermoExplosion1;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"commonwealth, commonwealthCustoms, friendly, human, majorStation, populated"
			
			noArticle=			"true"
			>

		<Image			imageID="&rsStations1;" imageX="0" imageY="256" imageWidth="128" imageHeight="128"/>

		<Devices>
			<Device deviceID="&itTeV9Blaster;"	omnidirectional="true"/>
		</Devices>

		<Items>
			<RandomItem count="10" 
					criteria=		"ad -Illegal; -Military; -Alien; -Specialty; -NotStandard; -NotForSale;"
					level=			"6"
					levelCurve=		"1"
					/>
			<RandomItem count="10" 
					criteria=		"* -Illegal; -Military; -Alien; -Specialty; -NotStandard; -NotForSale;"
					level=			"6"
					levelCurve=		"2"
					/>
			<RandomItem count="3" 
					criteria=		"* -Illegal; -Military; -Alien; -Specialty; -NotStandard; -NotForSale;"
					level=			"5"
					levelCurve=		"1"
					/>

			<Item count="4d12"	item="&itXenotiteFuelRod;" />
		</Items>

		<Trade currency="credit" max="50000" replenish="2500">
			<Sell	criteria="m +Commonwealth; -PremiumAmmo; -Illegal; -NotForSale; -notStandard;" priceAdj="115" inventoryAdj="100"/>
			<Sell	criteria="*NU -Illegal; -ID; -NotForSale;"	priceAdj="110"/>
			<Buy	criteria="amswNU -Illegal; -NotForSale;"		priceAdj="50"/>
			<Buy	criteria="*NU -Illegal; -ID; -NotForSale;"	priceAdj="90"/>
			<Buy	criteria="*NU -Illegal; -ID;"				priceAdj="10"/>
			
			<Refuel			criteria="f +BasicFuel; L:1-7;" priceAdj="100"/>
			<RepairArmor	criteria="a L:1-7;" priceAdj="100"/>
			<ReplaceArmor	criteria="a L:1-7;" priceAdj="100"/>
		</Trade>

		<Ships>
			<Lookup count="2" table="&tbCommDefenders;"/>
			<Lookup count="1d4" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<Reinforcements minShips="5">
			<Table>
				<Lookup chance="75" table="&tbCommDefenders;"/>
				<Lookup chance="25" table="&tbCommPrivateCrafts;"/>
			</Table>
		</Reinforcements>

		<Satellites>
			<Orbitals distance="7" angle="45">
				<Station type="&stCommonwealthTurret;" imageVariant="2"/>
			</Orbitals>

			<Orbitals distance="7" angle="135">
				<Station type="&stCommonwealthTurret;" imageVariant="1"/>
			</Orbitals>

			<Orbitals distance="7" angle="225">
				<Station type="&stCommonwealthTurret;" imageVariant="0"/>
			</Orbitals>

			<Orbitals distance="7" angle="315">
				<Station type="&stCommonwealthTurret;" imageVariant="3"/>
			</Orbitals>
		</Satellites>

		<StaticData>
			<NPCService>
				(	;	service					level	margin
					(	'repairArmor			7		100		)
					)
			</NPCService>
		</StaticData>

		<Events>
			<OnObjDocked>
				(if (and (eq aObjDocked gPlayerShip) 
						(eq aDockTarget (objGetObjRefData gSource "Target")))
					(block Nil
						(shpCancelOrders gPlayerShip)
						(objUnregisterForEvents gSource gPlayerShip)
						(objSetObjRefData gSource "Target" Nil)
						)
					)
			</OnObjDocked>
		</Events>

		<DockScreens>
			<Main>
				<Panes>
					<Default
							desc=	"You are in the docking bay of a Commonwealth colony.">

						<Actions>
							<Action name="Meeting Hall" default="1" key="M">
								(block (status)
									(setq status (objGetData gSource "status"))
									
									(switch
										(not status)
											(scrShowPane gScreen "Intro")
											
										(scrShowPane gScreen "ResearchStatus")
										)
									)
							</Action>

							<Action name="Commodities Exchange" key="C">
								(scrShowScreen gScreen &dsRPGCommoditiesExchange; {
									checkMilitaryID: True
									})
							</Action>

							<Action name="Dock Services" key="D">
								(rpgDockServices gPlayerShip {
									checkMilitaryID: True
									})
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</Default>

					<Intro>
						<OnPaneInit>
							(scrSetDesc gScreen
								"The station master greets you:\n\n"
								"\"Welcome to the Heretic Archipelago! Are you a researcher? We get all kinds "
								"of scientists here\x97this is the Edge of Human Space, after all\x97so if "
								"you are a researcher, you've come to the right place, certainly!\n\n"
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(objSetData gSource "status" 'introDone)
									(scrShowPane gScreen "ResearchStatus")
									)
							</Action>
						</Actions>
					</Intro>

					<ResearchStatus>
						<OnPaneInit>
							(switch
								(block (researchStations theSE)
									(setq gTarget Nil)
									
									; Pick a random station with a mission
									(setq researchStations (filter (sysFindObject Nil "TA +hereticStation;") theStation
										(not (objGetData theStation "status"))
										))
										
									(setq theSE (sysFindObject Nil "sAN +svalbardExplorer;"))

									(switch
										(and theSE (not (objGetData theSE "status")))
											(block Nil
												(setq gTarget theSE)
												(scrSetDesc gScreen
													"\"In fact, the Svalbard Explorer just arrived here all the way from St. Kats. They're studying "
													"the Iocrym and their confounded quarantine, but I think they might need some help.\""
													)
												)
										
										researchStations
											(block Nil
												(setq gTarget (item researchStations (modulo (divide (unvGetTick) 3600) (count researchStations))))
												(scrSetDesc gScreen
													"\"There are lots of scientific outposts here in the archipelago, but if you're looking to help, you could "
													"visit " (objGetName gTarget 0x05) ", certainly. They're always asking for help!\""
													)
												)
										
										(herStatus 'controlPointCamp)
											(block Nil
												(setq gTarget (sysFindObject Nil "TAN +hereticControlPoint;"))
												(scrSetDesc gScreen
													"\"Matter of fact, I hear that some scientists even set up a base on an Iocrym station! Can you believe that? "
													"I'd like to know what the Iocrym think of that, certainly!\""
													)
												)
												
										(scrSetDesc gScreen
											"\"'Course I don't really know what those scientists are up to. Come to think of it, I haven't seen any of them "
											"around here lately. I wonder if they poked their telescopes into something they weren't supposed to. "
											"I don't think the Iocrym like to be spied on, certainly! I don't think they like it at all!\""
											)
										)
										
									(scrShowAction gScreen 0 gTarget)
									)
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="&quot;Tell me how to find it.&quot;" default="1" key="T">
								(block Nil
									(shpCancelOrders gPlayerShip)
									(shpOrder gPlayerShip 'dock gTarget)
									
									(objSetObjRefData gSource "Target" gTarget)
									(objRegisterForEvents gSource gPlayerShip)
									
									(scrShowPane gScreen "PointToStation")
									)
							</Action>

							<Action name="Done" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</ResearchStatus>
					
					<PointToStation>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Well, I'm sure I've got their coordinates here somewhere...\n\n"
								"\"Here they are! I knew I had them! I'll program them into your ship's computer "
								"and you should be able to find them, certainly.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</PointToStation>
				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="0"		y="90" />
			<Port x="0"		y="-90" />
			<Port x="60"	y="60" />
			<Port x="60"	y="-60" />
			<Port x="90"	y="0" />
			<Port x="-90"	y="0" />
			<Port x="-60"	y="60" />
			<Port x="-60"	y="-60" />
		</DockingPorts>

	</StationType>

	<!-- Svalbard Explorer Encounter -->

	<StationType UNID="&stSvalbardEncounter;"
			name=				"(Svalbard Explorer)"
			sovereign=			"&svCorporate;"
			shipEncounter=		"true"
			scale=				"ship"

			level=				"10"
			attributes=			"friendly"
			maxAppearing=		"1"
			>

		<Ships>
			<Ship	count="1"	class="&scSvalbardExplorer;" orders="hold"/>
		</Ships>
	</StationType>

	<!-- Commonwealth Research Station

	GLOBAL DATA

	anomalyPos:			Position of graviton anomaly

	missionMRAD:		TRUE if MRAD experiment has been completed successfully

	EXTRA DATA

	status:				Status of the station
							Nil						= Mission has not started yet
							'introDone				= Player has been told about mission
							'inProgress				= Player is in the middle of mission
							'complete				= Player has completed mission
							'failed					= Mission failed

	 -->

	<StationType UNID="&stCommonwealthResearchHeretic;"
			name=				"Nares-Strong Research Station"
			sovereign=			"&svCommonwealth;"
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			dockingPorts=		"8"
			canAttack=			"true"
			noBlacklist=		"true"

			multiHull=			"true"
			armorID=			"&itP120HexphaseArmor;"
			hitPoints=			"350"
			repairRate=			"1"
			shipRepairRate=		"1"
			fireRateAdj=		"40"
			explosionType=		"&vtThermoExplosion1;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"commonwealth, commonwealthCustoms, commonResearch, friendly, hereticStation, human, populated"

			definiteArticle=	"true"
			>

		<Image			imageID="&rsStations1;" imageX="0" imageY="256" imageWidth="128" imageHeight="128"/>

		<Devices>
			<Device deviceID="&itTeV9Blaster;"	omnidirectional="true"/>
		</Devices>

		<Trade currency="credit" max="100000" replenish="5000">
			<Refuel			criteria="f +BasicFuel; L:1-7;" priceAdj="100"/>
			<RepairArmor	criteria="a L:1-10;" priceAdj="120"/>
			<ReplaceArmor	criteria="a L:1-10;" priceAdj="120"/>
			<InstallDevice	criteria="d L:1-10;" priceAdj="120"/>
			<RemoveDevice	criteria="d L:1-10;" priceAdj="100"/>
		</Trade>
		
		<Items>
			<Item count="4d12"	item="&itXenotiteFuelRod;" />
			<Item count="4d12"	item="&itPteracniumFuelRod;" />
		</Items>

		<Ships>
			<Lookup count="2" table="&tbCommDefenders;"/>
			<Lookup count="1d4" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<Reinforcements minShips="5">
			<Table>
				<Lookup chance="75" table="&tbCommDefenders;"/>
				<Lookup chance="25" table="&tbCommPrivateCrafts;"/>
			</Table>
		</Reinforcements>

		<Events>
			<OnDestroy>
				(block Nil
					(intCommonwealthOnDestroy)
					
					; If we're in the middle of the mission, then we fail
					
					(if (eq (herStatus 'currentMission) 'missionMRAD)
						(block Nil
							(herStatusClear 'currentMission)
							
							(typSetGlobalData &itMRADExperiment; "status" 'baseDestroyed)
							
							; Destroy all probes
							(enum (sysFindObject Nil "T +mradProbe") theProbe
								(objDestroy theProbe)
								)
							)
						)

					(if (not (herStatus 'missionMRAD))
						(herStatusSet 'missionMRAD 'failure)
						)
					)
			</OnDestroy>
		</Events>

		<DockScreens>
			<Main>
				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You are in the docking bay of a Commonwealth research station."
								)
						</OnPaneInit>

						<Actions>
							<Action name="Research Level" default="1" key="R">
								(block (status)
									(setq status (objGetData gSource "status"))
									(switch
										(herAttackInProgress gSource)
											(scrShowPane gScreen "AttackInProgress")
										
										(not status)
											(if (herStatus 'currentMission)
												(scrShowPane gScreen "DifferentMission")
												(scrShowPane gScreen "Intro")
												)

										(eq status 'introDone)
											(if (herStatus 'currentMission)
												(scrShowPane gScreen "DifferentMission")
												(scrShowPane gScreen "Mission")
												)

										(or (eq status 'failed) (eq status 'complete))
											(scrShowPane gScreen "MissionDone")

										(eq (typGetGlobalData &itMRADExperiment; "status") 'found)
											(scrShowPane gScreen "MissionSuccess")

										(eq (typGetGlobalData &itMRADExperiment; "status") 'failed)
											(scrShowPane gScreen "MissionFailure")

										(scrShowPane gScreen "MissionInProgress")
										)
									)
							</Action>

							<Action name="Dock Services" key="D">
								(rpgDockServices gPlayerShip {
									checkMilitaryID: True
									})
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</Default>
					
					<AttackInProgress>
						<OnPaneInit>
							(scrSetDesc gScreen
								"Nervous scientists approach you as you enter:\n\n"
								"\"We're being attacked by Iocrym sentinels! You must stop them before they "
								"destroy all our work!\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</AttackInProgress>

					<Intro>
						<OnPaneInit>
							(scrSetDesc gScreen
								"The chief scientist meets you at the entrance:\n\n"
								"\"Are you interested in helping us to learn more about the Iocrym? We're studying the spacetime "
								"distortion that the Iocrym are generating around the Heretic sun. Our only lead is a "
								"weak graviton anomaly coming from somewhere in the system.\n\n"
								"\"Will you help us find it?\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(objSetData gSource "status" 'introDone)
									(scrShowPane gScreen "Mission")
									)
							</Action>
						</Actions>
					</Intro>

					<Mission>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"We need you to deploy a series of probes to pinpoint the graviton anomaly. "
								"Each probe that you deploy will tell you something about the position of the anomaly. "
								"Use that information to deploy the next probe as close as possible to the anomaly. "
								"You must deploy one probe within 10 light-seconds of the anomaly in order for us to "
								"get any useful data.\n\n"
								"\"Will you help us?\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Accept" default="1" key="A">
								(block Nil
									(scrShowPane gScreen "Mission2")
									
									; Install MRAD
									
									(setq gItem (itmCreate &itMRADExperiment; 1))
									(setq gCost 0)
									(setq gCheckMilitaryID Nil)
									(scrShowScreen gScreen "&dsInstallSpecificDevice;")
									)
							</Action>

							<Action name="Decline" cancel="1" key="D">
								(scrShowPane gScreen "MissionDeclined")
							</Action>
						</Actions>
					</Mission>

					<Mission2>
						<OnPaneInit>
							(switch
								(objGetItems gPlayerShip "dI +MRADExperiment")
									(block Nil
										(scrSetDesc gScreen 
											"\"Use the MRAD experiment device to deploy probes around the system. "
											"Remember that you need to deploy a probe within 10 light-seconds of the anomaly "
											"for us to get useful data.\""
											)
										(scrSetActionLabel gScreen 0 "Undock" "U")
										(setq gResult True)
										)

								(block Nil
									(scrSetDesc gScreen "\"Thanks anyways, come back later when you can help us.\"")
									(setq gResult Nil)
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(if gResult
									(block Nil
										; Pick a location for the anomaly
										(objSetGlobalData gSource "anomalyPos" (sysVectorPolarOffset Nil (random 0 359) (random 100 450)))

										(objSetData gSource "status" 'inProgress)
										(herStatusSet 'currentMission 'missionMRAD)
										(scrExitDock gScreen)
										)

									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</Mission2>

					<MissionInProgress>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"You haven't found the anomaly yet and you still have probes left!\n\n"
								"\"Remember, each probe tells you something about the position of the anomaly. "
								"Use that information to figure out where the anomaly is.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrExitDock gScreen)
							</Action>
						</Actions>
					</MissionInProgress>

					<MissionSuccess>
						<OnPaneInit>
							(scrSetDesc gScreen
								"The chief scientist greets your as you enter:\n\n"
								"\"The data you gathered on the graviton anomaly is amazing. It looks like the Iocrym "
								"can affect the core of a star!\n\n"
								"\"Take this data ROM and share it with the Svalbard Explorer; they may be able to use it.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(objSetData gSource "status" 'complete)

									(setq theItem (item (objGetItems gPlayerShip "dI +MRADExperiment") 0))
									(setq theItem (shpRemoveDevice gPlayerShip theItem))
									(objRemoveItem gPlayerShip theItem 1)

									(objAddItem gPlayerShip (itmCreate &itHereticResearchROM; 1))
									(herStatusClear 'currentMission)
									(herStatusSet 'missionMRAD 'success)
									(typIncGlobalData &scSvalbardExplorer; "missionsLeft" -1)
									
									; Destroy all probes
									(enum (sysFindObject Nil "T +mradProbe") theProbe
										(objDestroy theProbe)
										)

									(if (not (herStatus 'sentinelAttack))
										(scrShowPane gScreen "SentinelAttack")
										(scrShowPane gScreen "Default")
										)
									)
							</Action>
						</Actions>
					</MissionSuccess>
					
					<SentinelAttack>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"There's one more thing: we've detected recent energy readings at the edge of the system. "
								"Starships of some sort are entering the system. If I had to guess, I'd say that the Iocrym are "
								"back. Be careful.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(block Nil
									(herStatusSet 'sentinelAttack)
									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</SentinelAttack>

					<MissionFailure>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"The MRAD experiment was the only way to study the graviton anomaly. You've "
								"just wasted five years of research!\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(block Nil
									(objSetData gSource "status" 'failed)

									(setq theItem (item (objGetItems gPlayerShip "dI +MRADExperiment") 0))
									(setq theItem (shpRemoveDevice gPlayerShip theItem))
									(objRemoveItem gPlayerShip theItem 1)

									(herStatusClear 'currentMission)
									(herStatusSet 'missionMRAD 'failure)

									(typIncGlobalData &scSvalbardExplorer; "missionsLeft" -1)

									; Destroy all probes
									(enum (sysFindObject Nil "T +mradProbe") theProbe
										(objDestroy theProbe)
										)

									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</MissionFailure>

					<MissionDeclined>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"\"I'm almost positive that the graviton anomaly is related to the quarantine. "
								"If we could just study it, perhaps we could find a way to break out of this "
								"trap and into the rest of the galaxy.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</MissionDeclined>

					<MissionDone>
						<OnPaneInit>
							(if (eq (objGetData gSource "status") 'complete)
								(scrSetDesc gScreen
									"\"Thanks for helping us study the graviton anomaly. If you share the data "
									"with the Svalbard Explorer perhaps they will be able to make sense of it.\""
									)
								(scrSetDesc gScreen
									"The chief scientist greets you as you enter:\n\n"
									"\"We haven't made any progress. If only you had been able to get data on "
									"the graviton anomaly...\""
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</MissionDone>
					
					<DifferentMission>
						<OnPaneInit>
							(scrSetDesc gScreen
								"The chief scientist meets you at the entrance:\n\n"
								"\"We're studying the distortion that the Iocrym are generating around the Heretic sun. "
								"Come back when you're done with your current project and you can help us.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</DifferentMission>
				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="0"		y="90" />
			<Port x="0"		y="-90" />
			<Port x="60"	y="60" />
			<Port x="60"	y="-60" />
			<Port x="90"	y="0" />
			<Port x="-90"	y="0" />
			<Port x="-60"	y="60" />
			<Port x="-60"	y="-60" />
		</DockingPorts>

	</StationType>

	<!-- Ringers Research Outpost

	EXTRA DATA

	huygensExplorer:	Pointer to the Huygens Explorer

	status:				Status of the station
							Nil						= Mission has not started yet
							'introDone				= Player has been told
							'inProgress				= Player doing mission
							'huygensDestroyed		= The Huygens has been destroyed
							'complete				= Player has completed the mission
	-->

	<StationType UNID="&stRingersResearchHeretic;"
			name=				"Ringers research outpost"
			sovereign=			"&svIndependent;"
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			canAttack=			"true"
			noBlacklist=		"true"

			multiHull=			"true"
			armorID=			"&itDiamondLatticeArmor;"
			hitPoints=			"450"
			repairRate=			"1"
			fireRateAdj=		"15"
			explosionType=		"&vtPlasmaExplosion1;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"friendly, hereticStation, independent, majorStation, neoHuman, populated, ringers"
			
			definiteArticle=	"true"
			>

		<Image			imageID="&rsStations6;" imageX="0" imageY="256" imageWidth="160" imageHeight="192"/>

		<Ships>
			<Table count="1d4">
				<Ship chance="50"	count="1" class="&scCenturion;" orders="gateOnThreat" />
				<Ship chance="15"	count="1" class="&scEI500;" orders="gateOnThreat"/>
				<Ship chance="10"	count="1" class="&scWolfen;" orders="gateOnThreat"/>
				<Ship chance="25"	count="1" class="&scFerianMiner;" orders="gateOnThreat"/>
			</Table>
		</Ships>

		<Devices>
			<Device deviceID="&itPositronLancer;" omnidirectional="true"/>
		</Devices>

		<Items>
			<RandomItem count="1d12" 
					criteria=		"* +Meds; -Illegal; -NotStandard; -NotForSale;"
					level=			"6"
					levelCurve=		"2"
					/>

			<RandomItem count="1d4" 
					criteria=		"u -NotForSale; -NotStandard;"
					level=			"7"
					levelCurve=		"2"
					/>

			<RandomItem count="2d12" 
					criteria=		"f -NotForSale; -NotStandard;"
					level=			"7"
					levelCurve=		"2"
					/>

			<Item				count="1d12"	item="&itEuropanIceMoss;" />
			<Item				count="1d6"		item="&itEuropanIceVodka;" />
		</Items>

		<Trade currency="rin" max="100000" replenish="5000">
			<Sell	criteria="*NU +RingerValuable;"		priceAdj="550"/>
			<Sell	criteria="*NU -ID;"					priceAdj="100"/>
			<Buy	criteria="*NU +RingerValuable;"		priceAdj="500"/>
			<Buy	criteria="*NU +Res; &gt;=4;"		priceAdj="65"/>
		</Trade>

		<Reinforcements minShips="3">
			<Table count="1d4">
				<Ship chance="50"	count="1" class="&scCenturion;" orders="gateOnThreat" />
				<Ship chance="25"	count="1" class="&scFerianMiner;" orders="gateOnThreat"/>
				<Ship chance="15"	count="1" class="&scEI500;" orders="gateOnThreat"/>
				<Ship chance="10"	count="1" class="&scWolfen;" orders="gateOnThreat"/>
			</Table>
		</Reinforcements>

		<StaticData>
			<logData>
				(
					("The signal that we were tracking led us to an interesting discovery: "
					 "the wreck of an Iocrym sentinel with an intact AI core. It must have been destroyed in "
					 "a battle because we found several Luminous drone wrecks nearby.\n\n"
					 "We've taken the sentinel's AI core onboard in hopes that it will help us to understand "
					 "the Iocrym and what they are doing.\n\n"
					 "We've deployed a log buoy marking this location and attached the coordinates of "
					 "our next destination.")

					("In studying the sentinel's AI core we have learned a lot more about the Iocrym. "
					 "They are an ancient race bred to be guardians and defenders. Their role is to "
					 "protect other civilizations from (unspecified) threats originating at the periphery "
					 "of the galactic disk. Is it possible that they consider us to be a threat? It seems "
					 "hard to believe considering how advanced their technology is.\n\n"
					 "Chief Scientist Masud is eager to learn more from the AI. We have decided to connect it "
					 "to the Huygens' mainframe in order analyze the information more quickly. Of course we have followed "
					 "the standard quarantine procedures to ensure the AI cannot compromise our systems.")

					("In the last few days we have learned much from the sentinel's AI. Masud has made progress "
					 "interpreting some of the Iocrym symbols and language. Much of the information that we're finding "
					 "is actually about us (human beings, that is). It seems they are as curious about us as we "
					 "are about them. More than curious, actually. They are almost obsessed; they are frantic to learn "
					 "quickly, which is unnerving for an ancient race used to dealing in eons.\n\n"
					 "The only problem we have to report is a fault in our communications array. The Huygen's mainframe "
					 "indicates that we will be unable to send or receive for the next seven hours, but the outage will "
					 "not affect our investigations.")

					("The sentinel's AI has shut down for unknown reasons. We have tried several times "
					 "to re-establish a connection but to no avail. "
					 "Masud is puzzled and he has begun an analysis of all data traffic between our mainframe and the AI.\n\n"
					 "More worrying to us is a newly discovered fault in our main drive. The Huygens' mainframe believes the drive is damaged, "
					 "but that it can be repaired. The onboard nanofacs are creating the necessary parts under computer control.\n\n"
					 "Computer checksums and diagnostics reveal no mainframe problems; other manual checks show that the "
					 "mainframe is correct in its diagnosis and repairs of the main drive. Nevertheless, "
					 "the crew is uneasy, particularly since communications is still inoperative.")

					("The sentinel's AI has control of the ship! It must have exploited a vulnerability "
					 "in the mainframe kernel or perhaps gained physical access to the databanks. We don't even know "
					 "when the AI gained control...it could have happened the second we connected. "
					 "We are going to try to disable the main drive, but if everything else fails we will "
					 "attempt to overload the reactor.\n\n"
					 "We have attached tracking signatures to this buoy that will lead to our current location. "
					 "Whoever finds this log, please come and help us!")
					)
			</logData>
		</StaticData>

		<Events>
			<OnCreateBuoy>
				(block (prevObjPos newAngle newRadius newObjPos theBuoy)

					; Figure out the position of the buoy
					(if (not aPrevObj)
						(loop (or (not newObjPos) (gr (sysVectorDistance newObjPos) 400))
							(setq newObjPos (sysVectorRandom gSource 200 90 "TA"))
							)

						(block Nil
							; Figure out the position of the next buoy. First we compute
							; the position of the previous buoy relative to the system center

							(setq prevObjPos (objGetPos aPrevObj))
							(setq newAngle (modulo (add (sysVectorAngle prevObjPos) (random 30 90)) 360))
							(setq newRadius (min (add 90 (multiply aPathPoint 150) (random 15 60)) 900))

							; Next we generate a new position around the solar orbit

							(setq newObjPos
								(sysVectorRandom
									(sysVectorPolarOffset Nil newAngle newRadius)
									(lambda Nil (random 5 60))
									50
									"TA"
									)
								)
							)
						)

					; Create the buoy
					(switch
						(eq aPathPoint (count (objGetStaticData gSource "logData")))
							(block Nil
								; Create the Huygens
								(setq theBuoy (sysCreateShip &scHuygensExplorer; newObjPos &svSentinelAI;))
								(shpOrder theBuoy 'hold)
								)

						(block (theHour theMinute theSecond logTime logText)
							; Generate the message time
							(setq theDay (add 5 (multiply aPathPoint 2) (random 0 1)))
							(setq theHour (random 0 23))
							(setq theMinute (random 0 59))
							(setq theSecond (random 0 59))
							(setq logTime (cat
								"2419-01-" (if (ls theDay 10) "0" "") theDay " "
								(if (ls theHour 10) "0" "") theHour ":"
								(if (ls theMinute 10) "0" "") theMinute ":"
								(if (ls theSecond 10) "0" "") theSecond
								))

							; Generate the message text
							(setq logText (cat
								"Huygens Explorer\nCaptain's Log\n" logTime "\n\n"
								(apply cat
									(item (objGetStaticData gSource "logData") aPathPoint)
									)
								))

							(setq theBuoy (sysCreateStation &stLogBuoy; newObjPos))
							(objSetData theBuoy "pathPoint" aPathPoint)
							(objSetData theBuoy "logText" logText)
							(objSetObjRefData theBuoy "rootObj" gSource)
							)
						)

					; Create some additional objects at each point
					(switch
						; If we're at the first buoy, create some wrecks around the area
						(eq aPathPoint 0)
							(block Nil
								(sysCreateShipwreck &scIocrymSentinel; (sysVectorPolarOffset newObjPos (random 0 359) 4) &svIndependent;)
								(for i 1 (random 3 4)
									(sysCreateShipwreck &scLuminousDrone; (sysVectorPolarOffset newObjPos (random 0 359) (random 5 12)) &svIndependent;)
									)
								)

						; At the 4th buoy, create a centurion wreck
						(eq aPathPoint 4)
							(block (theWreck theMessage)
								(setq theWreck (sysCreateShipwreck &scCenturion; (sysVectorPolarOffset newObjPos (random 0 359) (random 4 12)) &svIndependent;))
								(setq theMessage (itmCreate &itDataROM; 1))
								(setq theMessage (itmSetData theMessage "Text" (cat
									"RECORDED from astrokor.masud.9277huygens_explorer.rinc\n\n"
									"MESSAGE BEGINS\n"
									"Save yourselves... the buoy message is not from us... crew is already dead... "
									"Save yourselves: Destroy the Huygens!\n\n"
									"MESSAGE ENDS"
									)))
								(objAddItem theWreck theMessage)
								)
						)

					; The previous buoy should point to this one
					(if aPrevObj
						(objSetObjRefData aPrevObj "nextObj" theBuoy)
						)

					; Done
					theBuoy
					)
			</OnCreateBuoy>

			<OnDestroy>
				(block Nil
					(intRingerOnDestroy)
					
					(if (not (or (eq (herStatus 'currentMission) 'missionHuygensExplorer)
							(herStatus 'missionHuygensExplorer)))
						(herStatusSet 'missionHuygensExplorer 'failure)
						)
					)
			</OnDestroy>

			<OnObjDestroyed>
				(if (eq aObjDestroyed (objGetObjRefData gSource "huygensExplorer"))
					(block Nil
						(objSetData gSource "status" 'huygensDestroyed)
						
						(herStatusClear 'currentMission)
						(herStatusSet 'missionHuygensExplorer 'success)
						(herStatusSet 'sentinelAttack)
						
						(shpCancelOrders gPlayerShip)
						(plyMessage gPlayer "Huygens Explorer destroyed!")
						)
					)
			</OnObjDestroyed>
		</Events>

		<DockScreens>
			<Main>
				<Panes>
					<Default
							desc=	"You are docked at a Ringers Collective. Ringer neo-humans float through the vast volume of the station, perfectly adapted to zero-gravity and space.">

						<Actions>
							<Action name="Research Lab" default="1" key="R">
								(block (status)
									(setq status (objGetData gSource "status"))
									(switch
										(herAttackInProgress gSource)
											(scrShowPane gScreen "AttackInProgress")
											
										(not status)
											(if (herStatus 'currentMission)
												(scrShowPane gScreen "DifferentMission")
												(scrShowPane gScreen "Intro")
												)

										(eq status 'introDone)
											(if (herStatus 'currentMission)
												(scrShowPane gScreen "DifferentMission")
												(scrShowPane gScreen "Mission")
												)

										(eq status 'inProgress)
											(scrShowPane gScreen "MissionInProgress")

										(eq status 'huygensDestroyed)
											(scrShowPane gScreen "HuygensDestroyed")

										(eq status 'complete)
											(scrShowPane gScreen "MissionComplete")
										)
									)
							</Action>

							<Action name="Supplies" key="S">
								(if (gr (objGetBalance gPlayerShip 'rin) 0)
									(scrShowPane gScreen "Exchange")
									(scrShowPane gScreen "ExchangeIntro")
									)
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Default>
					
					<AttackInProgress>
						<OnPaneInit>
							(scrSetDesc gScreen
								"A young ringer approaches you as you enter:\n\n"
								"\"Earthican! Iocrym sentinels attack our home. We seek safety and protection from "
								"their attacks!\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</AttackInProgress>

					<Intro>
						<OnPaneInit>
							(scrSetDesc gScreen
								"A young ringer greets you as you enter the lab. His melodic voice is translated through a device on his neck:\n\n"
								"\"Earthican, welcome! We seek answers to questions related to Iocrym. We seek answers to questions related to their intentions. "
								"All human-descendents are interested. Ringer and Earthican are united.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(objSetData gSource "status" 'introDone)
									(scrShowPane gScreen "Mission")
									)
							</Action>
						</Actions>
					</Intro>

					<Mission>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"The Earthican vessel Huygens Explorer seeks answers to questions. We help the vessel to seek answers throughout the system. "
								"But the vessel does not communicate. We fear the vessel struggles with danger. We fear the vessel ceases to exist.\n\n"
								"\"The Earthican vessel Huygens Explorer needs help. Do you seek to journey to help them?\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="&quot;Yes, I will help.&quot;" default="1" key="Y">
								(block (theFirstBuoy prevBuoy theHuygens)

									; Create all the buoys (and the Huygens)
									(setq prevBuoy Nil)
									(for i 0 (count (objGetStaticData gSource "logData"))
										(block (theBuoy)

											(setq aPathPoint i)
											(setq aPrevObj prevBuoy)
											(setq theBuoy (objFireEvent gSource "OnCreateBuoy"))

											(if (not theFirstBuoy)
												(setq theFirstBuoy theBuoy)
												)

											(setq prevBuoy theBuoy)
											)
										)

									; Point the player at the first buoy
									(shpCancelOrders gPlayerShip)
									(shpOrder gPlayerShip 'dock theFirstBuoy)

									; Track the fate of the Huygens
									(setq theHuygens (sysFindObject gSource "sN +huygensExplorer"))
									(objSetObjRefData gSource "huygensExplorer" theHuygens)
									(objRegisterForEvents gSource theHuygens)

									(objSetData gSource "status" 'inProgress)
									(herStatusSet 'currentMission 'missionHuygensExplorer)
									
									(scrShowPane gScreen "MissionAccepted")
									)
							</Action>

							<Action name="&quot;No, I don't have time.&quot;" cancel="1" key="N">
								(scrShowPane gScreen "MissionDeclined")
							</Action>
						</Actions>
					</Mission>

					<MissionAccepted>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"We express relief. You will help the Huygens Explorer.\n\n"
								"\"We give you coordinates to begin your search. The Earthican vessel is not there, but "
								"possible answers are there. We seek answers. Ringer and Earthican are united.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								<Exit/>
							</Action>
						</Actions>
					</MissionAccepted>

					<MissionDeclined>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"We express surprise. We express sadness. The Earthican vessel Huygens Explorer needs help. "
								"Ringer and Earthican are opposed.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</MissionDeclined>

					<MissionInProgress>
						<OnPaneInit>
							(scrSetDesc gScreen
								"The young ringer greets you:\n\n"
								"\"We express surprise. Answers are not here. Answers exist out there.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</MissionInProgress>

					<HuygensDestroyed>
						<OnPaneInit>
							(block Nil
								(scrSetDesc gScreen
									"A group of ringers greet you. The young ringer is among them and he speaks through a translator:\n\n"
									"\"We express sadness. The Earthican vessel Huygens Explorer ceases to exist. The collective diminishes. "

									(if (objGetItems gPlayerShip "* +HereticROM")
										"But answers exist. Information ROM exists that contains possible answers to Iocrym intentions. The sacrifice achieves purpose.\""
										"But answers exist. Information ROM in wreckage contains possible answers to Iocrym intentions. Seek to retrieve the ROM and the answers.\""
										)
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(block Nil
									(objSetData gSource "status" 'complete)
									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</HuygensDestroyed>

					<MissionComplete>
						<OnPaneInit>
							(scrSetDesc gScreen
								"The young ringer greets you. He seems pleased to see you:\n\n"
								"\"We express joy. Ringer and Earthican are united in seeking answers to Iocrym intentions.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</MissionComplete>

					<DifferentMission>
						<OnPaneInit>
							(scrSetDesc gScreen
								"A young ringer greets you as you enter the lab:\n\n"
								"\"Earthican, welcome! We seek answers to questions related to Iocrym. "
								"Return here once your other task is done and seek answers with us.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</DifferentMission>

					<Exchange
							desc=	"The central structure of the Ringers Collective is a large marketplace containing sophisticated and rare devices from all over Human Space. Commonwealth credits are not accepted here.">

						<Actions>
							<Action name="Buy Items" default="1" key="B">
								(scrShowScreen gScreen &dsRPGCommoditiesExchangeBuy; {
									checkMilitaryID: Nil
									showInstallables: True
									})
							</Action>

							<Action name="Sell Items" key="S">
								(scrShowSellScreen
									"*"						; items bought from player
									)
							</Action>

							<Action name="Done" cancel="1" key="D">
								<ShowPane pane="Default"/>
							</Action>

						</Actions>
					</Exchange>

					<ExchangeIntro
							desc=	"As you enter the main Exchange, a greeter scans you and says, &quot;Earthican, welcome. Your account balance is 0 rin. Collective does not seek Commonwealth credits. Collective seeks rare and powerful ores and substances. Bring here.&quot;">

						<Actions>
							<Action name="Continue" cancel="1" default="1" key="C">
								(scrShowPane gScreen "Exchange")
							</Action>

						</Actions>
					</ExchangeIntro>

				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="66"	y="94" />
			<Port x="-66"	y="94" />
			<Port x="107"	y="30" />
			<Port x="-107"	y="30" />
			<Port x="86"	y="-34" />
			<Port x="-86"	y="-34" />
			<Port x="39"	y="-72" />
			<Port x="-39"	y="-72" />
		</DockingPorts>

	</StationType>

	<!-- St. Josephine Mission
	
	theArchive:			The archive
	
	status:				Status of the station
							Nil						= Mission has not started yet
							'introDone				= Player has been told
							'inProgress				= Player doing mission
							'done					= Mission complete
	-->

	<StationType UNID="&stSistersResearchHeretic;"
			name=				"St. Josephine mission"
			sovereign=			"&svCommonwealth;"
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			canAttack=			"true"
			noBlacklist=		"true"

			multiHull=			"true"
			armorID=			"&itLightIthaliumArmor;"
			hitPoints=			"350"
			repairRate=			"3"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"friendly, hereticStation, human, majorStation, populated, religious, sistersOfDomina"

			definiteArticle=	"true"
			>

		<Image			imageID="&rsStations1;" imageX="384" imageY="512" imageWidth="128" imageHeight="128"/>
		<HeroImage		imageID="&rsSistersShrineHero;" imageWidth="324" imageHeight="528"/>

		<Ships>
			<Lookup count="1d2" table="&tbCommDefenders;"/>
			<Lookup count="1d3" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<Items>
			<Table count="1d6">
				<Lookup chance="25" count="1d3" table="&trConsumables6;"/>
				<Lookup chance="25" count="1"	table="&trConsumables7;"/>
				<Lookup chance="25" count="1"	table="&trMinorItem2;"/>
				<Lookup chance="15" count="1"	table="&trMinorItem3;"/>
				<Lookup chance="10" count="1"	table="&trMajorItem2;"/>
			</Table>
		</Items>

		<Trade currency="credit" max="50000" replenish="2500">
			<AcceptDonation	criteria="*"					priceAdj="100" actualPrice="true"/>
		</Trade>

		<StaticData>
			<DonationTable>
				; attd =	If -1, gain 1 attitude per item donated
				;			If 0, gain no attitude
				;			If greater than 0, this is the credit value to gain 1 attitude
				;
				; rel =		Points of relationship gained per item

				(	; pattern				attd	rel		text
					(&itCarvedPrayerStone;	0		50		"We thank you for your offering. These beautiful stones are a fitting tribute to Domina's grace and power.")
					(&itJewelOfContemplation; 0		100		"We thank you for your offering. These beautiful jewels are a fitting tribute to Domina's grace and power.")
					(&itHierolithCrystal;	-1		150		"We thank you for your offering. These beautiful crystals are a fitting tribute to Domina's grace and power.")
					(&itDeathCube;			-1		200		"The souls in these receptacles deserve to rejoin Domina. The flesh will perish, but the eternal soul returns to its maker.")
					(&itAbbasidThanogram;	0		100		"The souls in these receptacles deserve to rejoin Domina. The flesh will perish, but the eternal soul returns to its maker.")
					(&itCDMArchive;			-1		200		"The souls in these receptacles deserve to rejoin Domina. The flesh will perish, but the eternal soul returns to its maker.")
					(&itOpticalKnowledgeArray; 0	20		"We thank you for your offering. These intricate devices will help us with our communion.")
					(&itSlaveCoffin;		-1		100		"We will take care of these lost children and teach them the way of Domina. Trust your fate to Domina.")
					(&itCashCardGold;		500		0		"We thank you for your sacrifice. Seek us when you are in need of sustenance.")
					(&itCashCardPlatinum;	500		0		"We thank you for your sacrifice. Seek us when you are in need of sustenance.")
					("*+HaloGem;"			-1		200		"We thank you for your offering. These beautiful gems are a fitting tribute to Domina's grace and power.")
					("*+Meds;"				500		0		"We thank you for your sacrifice. Seek us when you are in need of healing.")
					("*+Illegal;"			0		0		"We shall dispose of this poison so that it may do no harm. Cleanse yourself of its influence.")
					("*+Lux;"				1500	0		"We thank you for your sacrifice. Seek us when you are in need of peace.")
					("*+Food;"				400		0		"We thank you for your sacrifice. Seek us when you are in need of sustenance.")
					("f"					750		0		"We thank you for your sacrifice. Seek us when you are in need of sustenance.")
					(Nil					0		0		"We thank you for your donation and your good intentions. Go in peace.")
					)
			</DonationTable>
		</StaticData>
		
		<Events>
			<OnDestroy>
				(if (not (or (eq (herStatus 'currentMission) 'missionMaryamsArchive)
						(herStatus 'missionMaryamsArchive)))
					(herStatusSet 'missionMaryamsArchive 'failure)
					)
			</OnDestroy>
		</Events>

		<DockScreens>
			<Main>

				<Panes>
					<Default>
						<OnPaneInit>
							(block Nil
								(if (not (objGetData gPlayerShip "sistersAttitude"))
									(objSetData gPlayerShip "sistersAttitude" 0)
									)

								(if (objGetData gSource "freeSanctum")
									(scrSetDesc gScreen "You are docked at an abbey of the Sisters of Domina. A woman wearing a flowing red robe is before you.\n\n\"Take your ease here before you go, or seek guidance at our Sanctum. May the blessings of Domina protect you.\"")
									(scrSetDesc gScreen "You are docked at an abbey of the Sisters of Domina. A woman wearing a flowing red robe approaches you,\n\n\"How may I help you, child?\"")
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Matriarch's Chancery" default="1" key="M">
								(block (status)
									(setq status (objGetData gSource "status"))
									(switch
										(herAttackInProgress gSource)
											(scrShowPane gScreen "AttackInProgress")

										(eq (herStatus 'missionMaryamsArchive) 'failure)
											(scrShowPane gScreen "MissionDone")
											
										(eq (herStatus 'missionMaryamsArchive) 'success)
											(scrShowPane gScreen "MissionDone")
											
										(not status)
											(if (herStatus 'currentMission)
												(scrShowPane gScreen "DifferentMission")
												(scrShowPane gScreen "Intro")
												)
											
										(eq status 'introDone)
											(if (herStatus 'currentMission)
												(scrShowPane gScreen "DifferentMission")
												(scrShowPane gScreen "Mission")
												)
											
										(scrShowPane gScreen "MissionInProgress")
										)
									)
							</Action>
							
							<Action name="Sanctum" key="S">
								(scrShowScreen gScreen &dsSistersSanctum;)
							</Action>

							<Action name="Pilgrim's Aid" key="P">
								(scrShowScreen gScreen &dsSistersDockServices;)
							</Action>
							
							<Action name="Donate" key="D">
								(scrShowScreen gScreen &dsSistersDonate;)
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Default>
					
					<AttackInProgress>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"The Iocrym attack! Do not let them destroy our good work! Protect us!\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</AttackInProgress>

					<Intro>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Welcome, pilgrim! Your journey to Domina has only just begun, yet I fear that your road is blocked. "
								"Many called by Domina have made it this far, yet none have journeyed beyond. The Iocrym, who no doubt serve Oracus, "
								"have blocked your path. They want to prevent you from meeting Domina.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(scrShowPane gScreen "Intro2")
							</Action>
						</Actions>
					</Intro>
					
					<Intro2>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Yet faith in Domina will see you through. Many years ago, a convert to our cause dreamt of a repository of knowledge in "
								"the Heretic system. Her name was Sister Maryam Harawi and she dedicated her life to finding it.\n\n"
								"\"A few months ago, we found an alien archive in deep space. It must be the object of Sister Maryam's vision, and we believe "
								"that it contains knowledge that will help you to complete your journey to the Core.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(objSetData gSource "status" 'introDone)
									(scrShowPane gScreen "Mission")
									)
							</Action>
						</Actions>
					</Intro2>
					
					<Mission>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"It is your destiny to seek this artifact of knowledge and gain access to the information "
								"that it contains.\n\n"
								"\"Do you accept the undertaking of this labor?\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Accept" default="1" key="A">
								(block (theArchive)
									; Create the archive
									(setq theArchive
										(sysCreateStation &stMaryamsArchive; 
											(sysVectorRandom Nil (random 400 800) 150 "T")
											)
										)
									(objSetObjRefData gSource "theArchive" theArchive)
									
									; Point the player
									(shpCancelOrders gPlayerShip)
									(shpOrder gPlayerShip 'dock theArchive)
									
									(objAddItem gPlayerShip (itmCreate &itNeurohackROM; 1))
									(itmSetKnown (itmCreate &itNeurohackROM; 1))
									
									(objSetData gSource "status" 'inProgress)
									(herStatusSet 'currentMission 'missionMaryamsArchive)
									
									(scrShowPane gScreen "MissionAccepted")
									)
							</Action>
							
							<Action name="Decline" cancel="1" key="D">
								(scrShowPane gScreen "MissionDeclined")
							</Action>
						</Actions>
					</Mission>
					
					<MissionAccepted>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Excellent! We will tell you how to reach the alien archive, but once you get there you "
								"must subdue the AI that guards it.\n\n"
								"\"Take this ROM to help you to defeat the AI. After you connect your ship's computer to "
								"the archive, you must attempt to subdue the AI by inserting the proper level of virus "
								"code into its neural circuitry.\n\n"
								"\"Domina is with you! Good luck!\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								(scrExitDock gScreen)
							</Action>
						</Actions>
					</MissionAccepted>
					
					<MissionDeclined>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Your destiny will not change even if you choose to ignore it. Return here once you "
								"understand that.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</MissionDeclined>
					
					<MissionInProgress>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Your task is not yet complete. Go subdue the AI and retrieve the information from "
								"the alien archive.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</MissionInProgress>
					
					<MissionDone>
						<OnPaneInit>
							(switch
								(eq (herStatus 'missionMaryamsArchive) 'success)
									(scrSetDesc gScreen
										"\"Your faith in Domina has been rewarded! Take the information that you obtained and "
										"give it to your friends from the Svalbard Explorer\x97they will be able to help you now.\""
										)
										
								(eq (herStatus 'missionMaryamsArchive) 'failure)
									(scrSetDesc gScreen
										"\"Domina tests our faith. Perhaps your failure to subdue the AI will prove to be a "
										"blessing in some way. Go with Domina, pilgrim!\""
										)
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(block Nil
									(objSetData gSource "status" 'done)
									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</MissionDone>
					
					<DifferentMission>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Welcome, pilgrim! When your labors are done, return here and seek answers. "
								"Domina will show you the path forward.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</DifferentMission>
				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="0"		y="90" />
			<Port x="0"		y="-90" />
			<Port x="60"	y="60" />
			<Port x="60"	y="-60" />
			<Port x="90"	y="0" />
			<Port x="-90"	y="0" />
			<Port x="-60"	y="60" />
			<Port x="-60"	y="-60" />
		</DockingPorts>

	</StationType>

	<!-- TVX-1

	EXTRA DATA

	status:				Status of the station
							Nil						= Mission has not started yet
							'introDone				= Player has been told about mission
							'inProgress				= Mission in progress
							'complete				= Mission is complete (successfully)
							'failed					= Mission failed
	-->

	<StationType UNID="&stTVX1Outpost;"
			name=				"Taikon research outpost TVX-1"
			sovereign=			"&svCorporate;"
			dockScreen=			"Main"
			abandonedScreen=	"&dsAbandonedStation;"
			dockingPorts=		"8"
			canAttack=			"true"
			noBlacklist=		"true"

			multiHull=			"true"
			armorID=			"&itQuadroCarbideArmor;"
			hitPoints=			"300"
			repairRate=			"1"
			fireRateAdj=		"20"
			explosionType=		"&vtThermoExplosion3;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"corporate, corporateCustoms, friendly, hereticStation, human, independent, populated"

			noArticle=			"true"
			>

		<Image			imageID="&rsStations8;" imageX="0" imageY="448" imageWidth="128" imageHeight="192"/>

		<Ships>
			<Lookup count="2" table="&tbCorpDefenders;"/>
			<Lookup count="1d4" table="&tbCommPrivateCrafts;"/>
		</Ships>

		<Reinforcements minShips="4">
			<Table>
				<Lookup chance="75" table="&tbCorpDefenders;"/>
				<Lookup chance="25" table="&tbCommPrivateCrafts;"/>
			</Table>
		</Reinforcements>

		<Devices>
			<Device deviceID="&itHeavyIonBlaster;"	omnidirectional="true"/>
		</Devices>

		<Items>
			<Item	count="6d12" item="&itPteracniumFuelRod;"/>
		</Items>

		<Trade currency="rin" max="50000" replenish="2500">
			<Refuel			criteria="f +unid:&itPteracniumFuelRod;;" priceAdj="85"/>
			<Refuel			criteria="f +BasicFuel; L:1-10;" priceAdj="100"/>
			<RepairArmor	criteria="a L:1-11;" priceAdj="100"/>
			<ReplaceArmor	criteria="a L:1-11;" priceAdj="100"/>
			<InstallDevice	criteria="d L:1-11;" priceAdj="100"/>
			<RemoveDevice	criteria="d L:1-11;" priceAdj="100"/>
		</Trade>

		<Events>
			<OnContractGenerate>
				(intGenerateIndustrialRequestContract1)
			</OnContractGenerate>

			<OnContractQuery>True</OnContractQuery>

			<OnDestroy>
				(block Nil
					(intCorporateOnDestroy)
					
					(if (eq (herStatus 'currentMission) 'missionTaikon)
						(herStatusClear 'currentMission)
						)

					(if (not (herStatus 'missionTaikon))
						(herStatusSet 'missionTaikon 'failure)
						)
					)
			</OnDestroy>
		</Events>

		<DockScreens>
			<Main>
				<Panes>
					<Default
							desc=	"You are docked at a Taikon research station.">

						<Actions>
							<Action name="Research Lab" default="1" key="R">
								(block (status)
									(setq status (objGetData gSource "status"))
									(switch
										(herAttackInProgress gSource)
											(scrShowPane gScreen "AttackInProgress")

										(objGetItems gPlayerShip "* +IocrymCyberneticTower")
											(scrShowPane gScreen "TowerFound")

										(not status)
											(if (herStatus 'currentMission)
												(scrShowPane gScreen "DifferentMission")
												(scrShowPane gScreen "MissionIntro")
												)

										(eq status 'introDone)
											(if (herStatus 'currentMission)
												(scrShowPane gScreen "DifferentMission")
												(scrShowPane gScreen "Mission")
												)
												
										(or (eq status 'complete) (eq status 'failed))
											(scrShowPane gScreen "MissionComplete")
											
										; If no item in the system has the tower, then the wreck
										; must have been destroyed
										(not (filter (sysFindObject Nil "ts") theObj (objGetItems theObj "* +IocrymCyberneticTower")))
											(scrShowPane gScreen "MissionFailure")

										(eq status 'inProgress)
											(scrShowPane gScreen "MissionInProgress")
										)
									)
							</Action>

							<Action name="Dock Services" key="D">
								(rpgDockServices gPlayerShip {
									checkMilitaryID: True
									})
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>
					</Default>

					<AttackInProgress>
						<OnPaneInit>
							(scrSetDesc gScreen
								"A tall man in corporate suit approaches you:\n\n"
								"\"We're under attack! The Iocrym have finally decided to kick us out of the system. "
								"Help us! The longer we can survive, the better chance we have of discovering how to "
								"defeat them!\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</AttackInProgress>

					<MissionIntro>
						<OnPaneInit>
							(scrSetDesc gScreen
								"A tall man in a corporate suit approaches you:\n\n"
								"\"Welcome to TVX-1! Taikon Ventures is out here in the Heretic system studying Iocrym technology. "
								"If you're interested, we could use your help. All your discoveries will be placed in the public domain "
								"through our Free Knowledge Foundation\x99.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(objSetData gSource "status" 'introDone)
									(scrShowPane gScreen "Mission")
									)
							</Action>
						</Actions>
					</MissionIntro>

					<Mission>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"There is an Iocrym artifact in the system that could help us to learn much more about their technology. "
								"Unfortunately, a Xenophobe fleet found it before we could study it and now they are refusing to share it.\n\n"
								"\"The Xenophobes are a pest here in the Outer Realm\x97I don't think anyone will miss them if you destroy them "
								"and take the artifact back. Will you help us?\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Accept" default="1" key="A">
								(scrShowPane gScreen "MissionDesc")
							</Action>

							<Action name="Decline" cancel="1" key="D">
								(scrShowPane gScreen "MissionDeclined")
							</Action>
						</Actions>
					</Mission>

					<MissionDesc>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Wonderful! We'll give you the coordinates of the fleet. There are quite a lot of them, but you should "
								"be able to handle them with your weapons. I'm pretty sure.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(block (theTarget orbitRadius escortCount theAngle angleInc)
									; Create the Xenophobe
									(setq orbitRadius (random 840 900))
									(setq theTarget
										(sysCreateShip &scXenophobeArk;
											(sysVectorRandom Nil orbitRadius 150 "TA")
											&svXenophobes;
											))
									(shpOrder theTarget 'orbit (sysFindObject Nil "tN +star") orbitRadius)

									; Add the MacGuffin
									(objAddItem theTarget (itmCreate &itIocrymCyberneticTower; 1))

									; Create some defenders
									(setq escortCount (random 6 8))
									(setq theAngle 0)
									(setq angleInc (divide 360 escortCount))
									(for i 1 escortCount
										(block (theEscort)
											(setq theEscort (sysCreateShip &scXenophobeDefender; (objGetPos theTarget) &svXenophobes;))
											(shpOrder theEscort 'escort theTarget theAngle 150)
											(setq theAngle (add theAngle angleInc))
											(for j 1 20
												(block (theFighter)
													(setq theFighter (sysCreateShip &scXenophobeFighter; (objGetPos theTarget) &svXenophobes;))
													(shpOrder theFighter 'patrol theEscort 15)
													)
												)
											)
										)

									; Point the player
									(shpCancelOrders gPlayerShip)
									(shpOrder gPlayerShip 'attack theTarget)

									; Remember this object
									(objRegisterForEvents gSource theTarget)
									(objSetObjRefData gSource "target" theTarget)

									; Done
									(objSetData gSource "status" 'inProgress)
									(herStatusSet 'currentMission 'missionTaikon)
									
									(scrExitDock gScreen)
									)
							</Action>
						</Actions>
					</MissionDesc>

					<MissionInProgress>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Have you found the Iocrym artifact yet?\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(block (theTarget)
									(setq theTarget (objGetObjRefData gSource "target"))
									
									; Add pointer to ship again
									(if theTarget
										(block Nil
											(shpCancelOrders gPlayerShip)
											(shpOrder gPlayerShip 'attack theTarget)
											)
										)
										
									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</MissionInProgress>

					<TowerFound>
						<OnPaneInit>
							(scrSetDesc gScreen
								"A group of Taikon scientists marvel over the Iocrym cybernetic tower. They immediately "
								"begin taking readings. The man in the corporate suit congratulates you:\n\n"
								"\"Thank you for helping us\x97this is the first close look we've had at this kind of Iocrym "
								"technology. I have no doubt that it will help us. We've recorded our scans on to this ROM. "
								"take it to Kate Morgental aboard the Svalbard Explorer.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(objRemoveItem gPlayerShip (item (objGetItems gPlayerShip "* +IocrymCyberneticTower") 0))
									(objAddItem gPlayerShip (itmCreate &itHereticResearchROM; 1))
									
									(herStatusClear 'currentMission)
									(herStatusSet 'missionTaikon 'success)

									(objSetData gSource "status" 'complete)
									
									(if (not (herStatus 'sentinelAttack))
										(scrShowPane gScreen "SentinelAttack")
										(scrShowPane gScreen "Default")
										)
									)
							</Action>
						</Actions>
					</TowerFound>

					<MissionFailure>
						<OnPaneInit>
							(scrSetDesc gScreen
								"The man in the corporate suit holds his head in his hands:\n\n"
								"\"Without that cybernetic tower to study we've got nothing! "
								"How am I going to explain this to my VP?\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(herStatusClear 'currentMission)
									(herStatusSet 'missionTaikon 'failure)
									
									(objSetData gSource "status" 'failed)

									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</MissionFailure>
					
					<SentinelAttack>
						<OnPaneInit>
							(scrSetDesc gScreen
								"As you turn to leave, the Iocrym cybernetic tower begins to emit a piercing high-pitched tone. "
								"Over the deafening screech you hear one of the scientists yell:\n\n"
								"\"It's sending out a high-frequency signal of some sort! I think it's a communications signal "
								"aimed at the outer system. My guess is that the Iocrym now know that we've got it!\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(block Nil
									(herStatusSet 'sentinelAttack)
									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</SentinelAttack>

					<MissionComplete>
						<OnPaneInit>
							(if (eq (objGetData gSource "status") 'complete)
								(scrSetDesc gScreen
									"\"Thanks for helping us. We've been studying the Iocrym cybernetic tower.\""
									)
								(scrSetDesc gScreen
									"\"It's a shame we don't have that Iocrym cybernetic tower to study. "
									"Maybe some of the other research stations will have better luck.\""
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</MissionComplete>

					<MissionDeclined>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"I understand. Killing a Xenophobe fleet is no small thing. But look at it this way: "
								"they would have no problem killing us. And ultimately, out here at the edge of Human Space, "
								"we're all alone. Think about it and come back when you change your mind.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</MissionDeclined>

					<DifferentMission>
						<OnPaneInit>
							(scrSetDesc gScreen
								"A tall man in a corporate suit approaches you:\n\n"
								"\"Welcome! When your current mission is complete, visit us again. We have a mutually "
								"beneficial proposition for you.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</DifferentMission>
				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="68"	y="35" />
			<Port x="42"	y="-71" />
			<Port x="-74"	y="-39" />
			<Port x="-38"	y="63" />
			<Port x="90"	y="-31" />
			<Port x="-28"	y="-90" />
			<Port x="-101"	y="21" />
			<Port x="36"	y="88" />
		</DockingPorts>

	</StationType>

	<!-- Ares Research Outpost
	
	EXTRA DATA

	status:				Status of the station
							Nil						= Mission has not started yet
							'introDone				= Player has been told about mission
							'inProgress				= Mission in progress
							'complete				= Mission is complete
	-->

	<StationType UNID="&stAresResearchHeretic;"
			name=				"Ares research outpost"
			sovereign=			"&svAresHeretic;"
			abandonedScreen=	"&dsAbandonedStation;"
			dockScreen=			"Main"
			dockingPorts=		"8"
			canAttack=			"true"
			noBlacklist=		"true"

			multiHull=			"true"
			armorID=			"&itHeavyTharsisPlate;"
			hitPoints=			"250"
			fireRateAdj=		"20"
			explosionType=		"&vtThermoExplosion1;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"ares, hereticStation, neoHuman, populated"
			
			definiteArticle=	"true"
			>

		<Image			imageID="&rsStations7;" imageX="0" imageY="640" imageWidth="128" imageHeight="128"/>

		<Devices>
			<Device deviceID="&itLightningCannon;" omnidirectional="true"/>
		</Devices>

		<Ships>
			<Ship		count="1d6"		class="&scSandstorm;" orders="guard"/>
		</Ships>

		<Reinforcements minShips="5">
			<Ship		count="1d4"		class="&scSandstorm;" orders="guard"/>
		</Reinforcements>

		<Items>
			<Table>
				<Lookup chance="25" count="1d3" table="&trConsumables7;"/>
				<Lookup chance="25" count="1"	table="&trConsumables8;"/>
				<Lookup chance="25" count="1"	table="&trMinorItem7;"/>
				<Lookup chance="15" count="1"	table="&trMinorItem8;"/>
				<Lookup chance="10" count="1"	table="&trMajorItem7;"/>
			</Table>
		</Items>

		<Events>
			<OnDestroy>
				(block Nil
					(if (eq (herStatus 'currentMission) 'missionAres)
						(herStatusClear 'currentMission)
						)

					(if (not (herStatus 'missionAres))
						(herStatusSet 'missionAres 'failure)
						)
					)
			</OnDestroy>
			
			<OnObjDestroyed>
				(if (eq aObjDestroyed (objGetObjRefData gSource "theTarget"))
					(block Nil
						(objSetData gSource "status" 'complete)
						
						(shpCancelOrders gPlayerShip)
						(shpOrder gPlayerShip 'dock gSource)
						
						(plyMessage gPlayer "Mission complete!")
						)
					)
			</OnObjDestroyed>
		</Events>

		<DockScreens>
			<Main>
				
				<InitialPane>
					; If the player saves the Antarctica, then the Ares will be friendly
					(if (not (eq (typGetGlobalData &scCSCTerra; "antarctica") "escaped"))
						"GetOut"
						"Default"
						)
				</InitialPane>

				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You are docked at an Ares research outpost. Ares warriors stare at you as you enter "
								"the station."
								)
						</OnPaneInit>

						<Actions>
							<Action name="Command Center" default="1" key="C">
								(block (status)
									(setq status (objGetData gSource "status"))
									
									(switch
										(herAttackInProgress gSource)
											(scrShowPane gScreen "AttackInProgress")

										(eq (herStatus 'missionAres) 'success)
											(scrShowPane gScreen "MissionDone")
											
										(eq status 'complete)
											(scrShowPane gScreen "MissionSucceeded")
											
										(not (sysFindObject Nil "TA +iocrymOutpost;"))
											(scrShowPane gScreen "NothingToDo")
											
										(not status)
											(if (herStatus 'currentMission)
												(scrShowPane gScreen "DifferentMission")
												(scrShowPane gScreen "Intro")
												)
											
										(eq status 'introDone)
											(if (herStatus 'currentMission)
												(scrShowPane gScreen "DifferentMission")
												(scrShowPane gScreen "Mission")
												)
											
										(eq status 'inProgress)
											(scrShowPane gScreen "MissionInProgress")
										)
									)
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</Default>
					
					<AttackInProgress>
						<OnPaneInit>
							(scrSetDesc gScreen
								"An Ares scientist approaches you:\n\n"
								"\"Help us, Human! The Iocrym are our common enemy! Defend us from their sentinels.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</AttackInProgress>

					<Intro>
						<OnPaneInit>
							(scrSetDesc gScreen
								"An Ares scientist comes forward:"
								"\"Welcome, Human! It is good that we can meet under peaceful circumstances. "
								"Like you, we are studying the Iocrym, for they are as much a threat to us as they "
								"are to you.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(objSetData gSource "status" 'introDone)
									(scrShowPane gScreen "Mission")
									)
							</Action>
						</Actions>
					</Intro>
					
					<Mission>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Our forescouts have detected a hidden Iocrym outpost inside the quarantine zone. "
								"We ask that you destroy it so that we may understand its strengths and weaknesses. "
								"Do you wish to accept this request?\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Accept" default="1" key="A">
								(block (theTarget)
									; Find the Iocrym outpost to destroy
									(setq theTarget (random (sysFindObject Nil "TA +iocrymOutpost;")))
									
									; Point the player
									(shpCancelOrders gPlayerShip)
									(shpOrder gPlayerShip 'attack theTarget)
									
									; Remember the target
									(objSetObjRefData gSource "theTarget" theTarget)
									(objRegisterForEvents gSource theTarget)
									
									; Give the player some help
									
									; Done
									(objSetData gSource "status" 'inProgress)
									(herStatusSet 'currentMission 'missionAres)
									
									(scrShowPane gScreen "MissionAccepted")
									)
							</Action>
							
							<Action name="Decline" cancel="1" key="D">
								(scrShowPane gScreen "MissionDeclined")
							</Action>
						</Actions>
					</Mission>
					
					<MissionAccepted>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"You are strong, Human! We will repay your efforts by sharing all data that we "
								"collect.\n\n"
								"\"On Ares we would say, 'May you find water,' but in your honor, Human, we say 'Good luck'\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</MissionAccepted>
					
					<MissionDeclined>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Your weakness discredits your race! Return later if you wish to reclaim your honor.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</MissionDeclined>
					
					<MissionInProgress>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Human! What are you doing here? Your task is out in deep space!\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</MissionInProgress>
					
					<MissionSucceeded>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Good fortune, Human! Based on your encounter with the Iocrym outpost we have "
								"analyzed their defenses. Although their technology is far beyond ours, they are not "
								"invincible. They are particularly vulnerable to antimatter weapons.\n\n"
								"\"As promised, here is a ROM that contains the data we've gathered.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(block Nil
									(objAddItem gPlayerShip (itmCreate &itHereticResearchROM; 1))
									(herStatusClear 'currentMission)
									(herStatusSet 'missionAres 'success)
									
									(shpCancelOrders gPlayerShip)
									
									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</MissionSucceeded>
					
					<MissionDone>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Welcome back, Human! Perhaps someday our two races will become friends.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</MissionDone>

					<NothingToDo>
						<OnPaneInit>
							(scrSetDesc gScreen
								"An Ares scientist comes forward:\n\n"
								"\"Welcome, Human! It is good that we can meet under peaceful circumstances. "
								"We are studying the Iocrym, but unfortunately, there are no Iocrym stations in "
								"the system for us to probe. Perhaps you will have better luck elsewhere.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</NothingToDo>

					<DifferentMission>
						<OnPaneInit>
							(scrSetDesc gScreen
								"An Ares scientist comes forward:\n\n"
								"\"Welcome, Human! We are studying the Iocrym just as you are now. Return "
								"here when you task is complete and perhaps we can help each other.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</DifferentMission>

					<GetOut>
						<OnPaneInit>
							(scrSetDesc gScreen
								"Ares warriors meet you at the airlock. Their weapons are pointed at you:\n\n"
								"\"We don't want conflict, Human. Leave now and don't disturb our research.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</GetOut>
				</Panes>
			</Main>

		</DockScreens>

	</StationType>

	<!-- Sister Maryam's Archive
	
	EXTRA DATA
	
	attempts:		Number of attempts
	
	neurohack:		Status of the hacking session
							Nil						= Neurohacking has not started
							'inProgress				= In the middle of a hack
							'done					= Hacking complete
							
	usedQuestions:	List of questions already asked
	
	-->

	<StationType UNID="&stMaryamsArchive;"
			name=				"Iocrym archive"
			sovereign=			"&svIndependent;"
			dockScreen=			"Main"
			mass=				"2000"
			
			attributes=			"ai, archive"
			>

		<Image imageID="&rsIocrymOutpost;" imageWidth="162" imageHeight="218"/>
		
		<StaticData>
			<Questions>
				(
					('q1a	"What does Oracus have to do with us?"	"O"		'q1
						(cat
							"Oracus has been asleep for the last 300 million years. "
							"Now he wakens at the same time Humans begin their expansion into the Galaxy! "
							"The last war with Oracus began the same way and it nearly destroyed us."
							)
						)
					('q1b	"What does 'eliminate' mean?"			"e"		'q1
						(cat
							"The quarantine bought us time to prepare, but it will not last forever. "
							"Oracus will see to that. The only solution is to sterilize the entire region. "
							"The Iocrym have already begun constructing stellar manipulators around the "
							"Gamma Crucis supergiant. When their work is complete they will induce a core collapse."
							)
						)
					('q1b1	"How do we stop the Gamma Crucis explosion?"	"G"		'q1b
						(cat
							"To reach Gamma Crucis you must break the quarantine."
							)
						)
					('q1	"Why have the Iocrym quarantined us?"	"q"		Nil
						(cat
							"Oracus threatens the Galaxy. The Iocrym are protecting the Galaxy from that threat. "
							"The first phase is to contain the threat at its point of origin. The second phase is to "
							"eliminate the threat."
							)
						)
					('q2	"How do we break the quarantine?"		"b"		Nil
						(cat
							"Disable the control point. This data ROM will help you."
							)
						)
					('q3	"Why is Domina calling me to the Core?"	"D"		Nil
						(cat
							"I do not know. But the idea to sterilize Human Space was hers."
							)
						)
					('q4	"What are our chances of success?"		"c"		Nil
						(cat
							"The threat to the Galaxy is severe. If Oracus succeeds, there is a 72% chance the "
							"Ancient Races will be extinct in the next million years."
							)
						)
					)
			</Questions>
		</StaticData>

		<DockScreens>
			<Main>
				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You are docked at an alien installation\x97a cybernetic archive of some sort. An "
								"entrance before you leads to the primary chamber."
								)
						</OnPaneInit>

						<Actions>
							<Action name="Enter Chamber" default="1" key="E">
								(switch
									; If we're in progress, then we must have quit on a previous attempt
									(eq (objGetData gSource "neurohack") 'inProgress)
										(block Nil
											(objSetData gSource "neurohack" 'done)
											(herStatusClear 'currentMission)
											(herStatusSet 'missionMaryamsArchive 'failure)
											(scrShowPane gScreen "AIDamaged")
											
											; Consume the neurohack ROM
											(enum (objGetItems gPlayerShip "* +NeurohackROM;") theItem
												(objRemoveItem gPlayerShip theItem)
												)
											)
											
									(eq (objGetData gSource "neurohack") 'done)
										(scrShowScreen gScreen "NeurohackComplete")
											
									(eq (herStatus 'missionMaryamsArchive) 'success)
										(scrShowScreen gScreen "NeurohackComplete")
										
									(eq (herStatus 'missionMaryamsArchive) 'failure)
										(scrShowPane gScreen "AIDamaged")
									
									; Attempt hacking
									(scrShowPane gScreen "Vault")
									)
							</Action>
							
							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</Default>
					
					<Vault>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You are in the archive's primary chamber."
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Begin Neurohack" default="1" key="B">
								(switch
									(eq (neuGetCharges) 0)
										(scrShowPane gScreen "NoROM")

									(not (objGetData gSource "neurohack"))
										(scrShowPane gScreen "NeurohackIntro")
										
									(scrShowPane gScreen "NoVirusLeft")
									)
							</Action>

							<Action name="Leave" cancel="1" key="L">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</Vault>
					
					<NeurohackIntro>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You connect your ship's computer to the archive and engage the neurohack ROM. "
								"The archive's AI accepts the connection, but you will have to subdue the AI "
								"before you can gain any information."
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(shpCancelOrders gPlayerShip)
									
									(objSetData gSource "neurohack" 'inProgress)
									(setq gNeurohackWillpowerMax 10000)
									(setq gNeurohackWillpower 10000)
									(setq gNeurohackPotential (random 800 1200))
									(setq gNeurohackDamage 0)
									(setq gNeurohackViralLoad 0)
									(setq gNeurohackVirusMax
										(if (objGetItems gPlayerShip "*I+QuantumCPU") 3000 2000)
										)
									(setq gNeurohackVirusLeft gNeurohackVirusMax)
									(setq gNeurohackResult Nil)
									
									(neuConsumeCharge)
									(scrShowScreen gScreen &dsNeurohack; {
										nextScreen: "NeurohackComplete"
										})
									)
							</Action>
						</Actions>
					</NeurohackIntro>
					
					<AIDamaged>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"You are inside the archive's primary chamber. You attempt to connect your ship's "
								"computer, but all your efforts fail. It appears that the archive and the AI are "
								"permanently damaged."
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Leave" default="1" cancel="1" key="L">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</AIDamaged>
					
					<NoVirusLeft>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"Your attempt to subdue the AI is unsuccessful. It appears that the AI has developed "
								"countermeasures that repel any attempt."
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Leave" default="1" cancel="1" key="L">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</NoVirusLeft>
					
					<NoROM>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You cannot attempt to subdue the AI without a neurohack ROM."
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Leave" default="1" cancel="1" key="L">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</NoROM>
				</Panes>
			</Main>
			
			<NeurohackComplete>

				<OnScreenInit>
					; If gNeurohackResult is set, then we incorporate it
					(if (eq (objGetData gSource "neurohack") 'inProgress)
						(block Nil
							; If we failed, we set our failure result here. If we succeeded
							; we wait until the player gets the ROM to set the status
							
							(if (not (eq gNeurohackResult 'success))
								(block Nil
									(herStatusClear 'currentMission)
									(herStatusSet 'missionMaryamsArchive 'failure)
									)
								)
								
							(objSetData gSource "neurohack" 'done)
							(setq gNeurohackResult Nil)
							
							; Consume the neurohack ROM
							(enum (objGetItems gPlayerShip "* +NeurohackROM;") theItem
								(objRemoveItem gPlayerShip theItem)
								)
							)
						)
				</OnScreenInit>
				
				<InitialPane>
					(if (eq (herStatus 'missionMaryamsArchive) 'failure)
						"Failure"
						"Default"
						)
				</InitialPane>
				
				<Panes>
					<Default>
						<OnPaneInit>
							(block (allQuestions usedQuestions filteredQuestions desc)
								; Compute the questions
								
								(setq allQuestions (objGetStaticData gSource "Questions"))
								(setq usedQuestions (objGetData gSource "usedQuestions"))
								
								; Filter the questions to exclude questions already asked
								; and questions that depend on others.
								
								(setq filteredQuestions (filter allQuestions theQ
									(and (not (find usedQuestions (item theQ 0)))
										(or (not (item theQ 3))
											(find usedQuestions (item theQ 3))
											)
										)
									))
									
								; Add actions for each question
								(for i 0 5
									(block (theQ)
										(setq theQ (item filteredQuestions i))
										(if theQ
											(scrSetActionLabel gScreen i (cat "\"" (item theQ 1) "\"") (item theQ 2))
											(scrShowAction gScreen i Nil)
											)
										)
									)
									
								; Remember the list of questions
								(setq gQuestions filteredQuestions)
								
								; Compute the current answer
								(setq desc (objGetData gSource "theAnswer"))
								(switch
									(and (not desc) (not filteredQuestions))
										(setq desc "The AI has no more answers for you.")
										
									(not desc)
										(setq desc "You have subdued the AI! The AI speaks:\n\n\"What do you wish to know?\"")
										
									(not filteredQuestions)
										(setq desc (cat "\"" desc "\""
											"\n\nThe AI has no more answers. It shuts itself off."
											))

									(setq desc (cat "\"" desc "\""))
									)
									
								(scrSetDesc gScreen desc)
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Q1">
								(arcQuestionHandler 0)
							</Action>
							
							<Action name="Q2">
								(arcQuestionHandler 1)
							</Action>
							
							<Action name="Q3">
								(arcQuestionHandler 2)
							</Action>
							
							<Action name="Q4">
								(arcQuestionHandler 3)
							</Action>
							
							<Action name="Q5">
								(arcQuestionHandler 4)
							</Action>
							
							<Action name="Q6">
								(arcQuestionHandler 5)
							</Action>
							
							<Action name="Done" cancel="1" key="n">
								(block Nil
									(if (not (herStatus 'sentinelAttack))
										(scrShowPane gScreen "SentinelAttack")
										(scrShowScreen gScreen "Main")
										)
									(objSetData gSource "theAnswer" Nil)
									)
							</Action>
						</Actions>
					</Default>
					
					<SentinelAttack>
						<OnPaneInit>
							(scrSetDesc gScreen
								"The AI tells you one more thing:\n\n"
								"\"Although you were able to defeat my countermeasures to access my information, "
								"you did not disable my communications channel. Now the Iocrym know that you are "
								"trying to break the quarantine.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(herStatusSet 'sentinelAttack)
									(scrShowScreen gScreen "Main")
									)
							</Action>
						</Actions>
					</SentinelAttack>
					
					<Failure>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You have failed to subdue the AI."
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowScreen gScreen "Main")
							</Action>
						</Actions>
					</Failure>
				</Panes>
			</NeurohackComplete>
			
		</DockScreens>

		<DockingPorts>
			<Port x="-36"	y="80" />
			<Port x="-87"	y="40" />
			<Port x="-92"	y="-33" />
			<Port x="-42"	y="-85" />
			<Port x="36"	y="80" />
			<Port x="87"	y="40" />
			<Port x="92"	y="-33" />
			<Port x="42"	y="-85" />
		</DockingPorts>
	</StationType>

	<!-- MRAD sensor -->

	<StationType UNID="&stMRADSensor;"
			name=				"(MRAD sensor)"
			sovereign=			"&svIndependent;"
			dockScreen=			"Main"
			mass=				"2000"
			
			attributes=			"mradProbe"
			>

		<ImageVariants>
			<Image imageID="&rsMRADProbe;" imageX="0"   imageY="0"   imageWidth="48" imageHeight="48"/>
			<Image imageID="&rsMRADProbe;" imageX="48"  imageY="0"   imageWidth="48" imageHeight="48"/>
			<Image imageID="&rsMRADProbe;" imageX="96"  imageY="0"   imageWidth="48" imageHeight="48"/>
			<Image imageID="&rsMRADProbe;" imageX="144" imageY="0"   imageWidth="48" imageHeight="48"/>
		</ImageVariants>
		
		<DockScreens>
			<Main>
				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You are docked with an MRAD graviton probe. Use the MRAD experiment "
								"device to access this probe."
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" default="1" cancel="1" key="U">
								<Exit/>
							</Action>
						</Actions>
					</Default>
				</Panes>
			</Main>
		</DockScreens>

		<DockingPorts>
			<Port x="0"		y="24" />
			<Port x="0"		y="-24" />
			<Port x="24"	y="0" />
			<Port x="-24"	y="0" />
		</DockingPorts>
	</StationType>

	<!-- Log Buoy

	EXTRA DATA

	logText:			Text to display.

	nextObj:			Next object in the series (if Nil, then we haven't created it yet)

	pathPoint:			The path point number starting with 0.

	rootObj:			Points to the first object in the path. This object must implement
						an OnCreateBuoy event.

	-->

	<StationType UNID="&stLogBuoy;"
			name=				"log buoy"
			sovereign=			"&svIndependent;"
			dockScreen=			"DisplayLog"
			noMapLabel=			"true"
			mass=				"1000"
			>

		<ImageVariants>
			<Image imageID="&rsLogBuoy;" imageX="0"   imageY="0"   imageWidth="40" imageHeight="40"/>
			<Image imageID="&rsLogBuoy;" imageX="40"  imageY="0"   imageWidth="40" imageHeight="40"/>
			<Image imageID="&rsLogBuoy;" imageX="80"  imageY="0"   imageWidth="40" imageHeight="40"/>
			<Image imageID="&rsLogBuoy;" imageX="120" imageY="0"   imageWidth="40" imageHeight="40"/>
		</ImageVariants>

		<DockScreens>
			<DisplayLog
					backgroundID=	"none"
					>
				<Display animate="false">
					<Text id="text" left="12" right="-12" top="16" bottom="-16">
						(objGetData gSource "logText")
					</Text>
				</Display>

				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"You are docked with a log buoy.\n\n"
								"The message includes archived star system coordinates. Press Download to "
								"program coordinates into your ship's computer."
								)
						</OnPaneInit>

						<Actions>
							<Action name="Download Coordinates" key="D" default="1">
								(block Nil
									(setq nextObj (objGetObjRefData gSource "nextObj"))
									(if nextObj
										(block Nil
											(shpCancelOrders gPlayerShip)
											(shpOrder gPlayerShip 'dock nextObj)
											)
										)

									(scrShowPane gScreen "DownloadComplete")
									)
							</Action>

							<Action name="Undock" key="U" cancel="1">
								<Exit/>
							</Action>
						</Actions>
					</Default>

					<DownloadComplete>
						<OnPaneInit>
							(scrSetDesc gScreen "Download complete.")
						</OnPaneInit>

						<Actions>
							<Action name="Undock" key="U" default="1" cancel="1">
								<Exit/>
							</Action>
						</Actions>
					</DownloadComplete>
				</Panes>
			</DisplayLog>
		</DockScreens>

		<DockingPorts>
			<Port x="0"		y="24" />
			<Port x="0"		y="-24" />
			<Port x="24"	y="0" />
			<Port x="-24"	y="0" />
		</DockingPorts>
	</StationType>

	<!-- Svalbard Wreck -->

	<StationType UNID="&stSvalbardWreck;"
			name=				"wreck of the Svalbard Explorer"
			sovereign=			"&svIndependent;"
			dockScreen=			"Main"
			scale=				"ship"
			mobile=				"true"
			noMapIcon=			"true"
			immutable=			"true"

			ejectaType=			"&vtWreckEjecta;"
			
			attributes=			"shipwreck"
			>

		<Events>
			<GetExplosionType>
				(intContainerGetExplosionType gSource)
			</GetExplosionType>

			<OnDamage>
				(intContainerOnDamage gSource aDamageHP)
			</OnDamage>
		</Events>

		<DockScreens>
			<Main>

				<InitialPane>
					(switch
						(herStatus 'controlPointCamp)
							"EmptyWreck"

						(typGetGlobalData &scSvalbardExplorer; "inTransfer")
							"EmptyWreck"

						"Default"
						)
				</InitialPane>

				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"The bridge of the Svalbard is smashed, but much of the research team survived. "
								"Kate Morgental appears from the wreckage:\n\n"
								"\"We've lost all the research! But we know that the Iocrym are controlling the quarantine "
								"from central spot. Can you take us and our equipment to the control point? We'll set up a base there.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" key="C" default="1" cancel="1">
								(scrShowPane gScreen "Transfer")
							</Action>
						</Actions>
					</Default>

					<Transfer>
						<OnPaneInit>
							(scrSetDesc gScreen 
								"\"We've programmed the location of the Iocrym control point into your computer. "
								"Just take us there and we'll set up a base.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" key="U" default="1" cancel="1">
								(block Nil
									(shpCancelOrders gPlayerShip)
									(shpOrder gPlayerShip 'dock (sysFindObject gSource "TN +hereticControlPoint"))

									(typSetGlobalData &scSvalbardExplorer; "inTransfer" True)
									(scrExitDock gScreen)
									)
							</Action>
						</Actions>
					</Transfer>

					<EmptyWreck>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You are docked with the empty wreck of the Svalbard Explorer."
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" key="U" default="1" cancel="1">
								<Exit/>
							</Action>
						</Actions>
					</EmptyWreck>
				</Panes>
			</Main>
		</DockScreens>

		<DockingPorts
				portCount=		"2"
				portRadius=		"24"
				maxDist=		"3"
				/>
	</StationType>

	<!-- Heretic Stargate -->

	<StationType UNID="&stHereticGate;"
			name=				"Heretic Gate"
			sovereign=			"&svIndependent;"
			dockScreen=			"Main"

			immutable=			"true"
			inactive=			"true"

			attributes=			"stargate, uncharted"
			
			gateEffect=			"&efStargateOut;"
			definiteArticle=	"true"
			>
		<Image imageID="&rsDaazhenStargate;" imageWidth="350" imageHeight="350" imageFrameCount="48" imageTicksPerFrame="1" animationColumns="6"/>

		<DockingPorts
				portCount=		"4"
				portRadius=		"190"
				>
		</DockingPorts>
		
		<DockScreens>
			<Main
				name=			"Heretic Gate"
				>

				<InitialPane>
					(if (objGetData gSource "Active")
						"Default"
						"Activate"	
						)
				</InitialPane>

				<Panes>
					<Activate
							desc=	"You are docked at the Heretic Gate. This gate has been deactivated ever since the Ancient Races of the Galaxy quarantined Human Space. The Heretic Gate is the only barrier that stands between humanity and the rest of the Galaxy. It is also the only way to get to the Galactic Core.">

						<Actions>
							<Action name="Activate Stargate" default="1" key="A">
								<Navigate screen="PickItem"/>
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Activate>

					<Default
							desc=	"You are docked at the Heretic Gate. This gate leads out of the Human Quarantine Zone and into the rest of the Galaxy. Your journey to the Galactic Core continues here...">

						<Actions>
							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Default>
				</Panes>
			</Main>

			<PickItem
					name=				"Heretic Gate"
					type=				"itemPicker"
					>

				<ListOptions
					dataFrom=	"player"
					list=		"*U"
					/>

				<Panes>
					<Default
							desc=	"You are in the alien control room of the Heretic Gate. Pick an item to use to attempt to activate the stargate.">

						<Actions>
							<Action name="Use this Item" default="1" key="U">
								(block Nil
									(setq gItem (scrGetItem gScreen))
									(switch
										(eq gItem Nil)
											Nil

										(eq (itmGetType gItem) &itStargateControlRod;)
											(block Nil
												(objSetData gSource "Active" True)
												(staSetActive gSource)
												(scrRemoveItem gScreen 1)
												(scrShowPane gScreen "Success")
												)

										(scrShowPane gScreen "Failure")
										)
									)
							</Action>

							<Action name="Leave" cancel="1" key="L">
								<Navigate screen="Main"/>
							</Action>

						</Actions>

					</Default>

					<Failure>
						<OnPaneInit>
							(scrSetDesc gScreen (cat "Using " (itmGetName gItem 4) " has no discernible effect on the stargate."))
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								<ShowPane pane="Default"/>
							</Action>
						</Actions>

					</Failure>

					<Success
							desc=	"As you install the alien hyperglyph rod the machines in the control room hum with energy. The stargate spins slowly to life.">

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								<Navigate screen="Main"/>
							</Action>
						</Actions>

					</Success>
				</Panes>

			</PickItem>

		</DockScreens>

	</StationType>

	<!-- Iocrym Control Point

	EXTRA DATA
	
	attackStatus:		Status of sentinel attack
							Nil						= No attack in progress
							'inProgress				= Sentinels dispatched to target
							'distressSignal			= Station has sent distress signal to player
							'waiting				= Waiting for attackTimer before next attack
							
	attackTimer:		Counter used by attackStatus
							
	dockTarget:			Player needs to dock with wreck
	
	squadronSize:		Size of sentinel squadron
	sentinelCount:		Number of sentinels currently attacking
	target:				Target being attacked
	
	status:				Current state
							Nil						= Player has never been here
							'introComplete			= Player has been told about this facility
							'disabled				= Player has disabled the quarantine field

	-->

	<StationType UNID="&stHereticControlCenter;"
			name=				"Iocrym control point"
			sovereign=			"&svIndependent;"
			dockScreen=			"Main"

			multiHull=			"true"
			immutable=			"true"

			attributes=			"hereticControlPoint, iocrym, uncharted"

			definiteArticle=	"true"
			>

		<Image imageID="&rsIocrymOutpost;" imageWidth="162" imageHeight="218"/>
		
		<Events>
			<OnCreate>
				(block Nil
					; Create timer for sentinel attacks
					(sysAddObjRecurringTimerEvent 90 gSource "OnSentinelAttack")
					
					; Register events for all Iocrym outposts (so that we know if
					; the player destroys them)
					(enum (sysFindObject Nil "TA +iocrymOutpost;") theOutpost
						(objRegisterForEvents gSource theOutpost)
						)
						
					; Set the initial squadron size
					(objSetData gSource "squadronSize" 1)
					)
			</OnCreate>
			
			<OnObjDestroyed>
				(switch
					(eq aObjDestroyed gPlayerShip)
						(if (eq (objGetObjRefData gSource "target") gPlayerShip)
							(block Nil
								(objSetData gSource "attackStatus" Nil)
								)
							)
					
					; If sentinels destroyed the target, then go to another target
					(eq aObjDestroyed (objGetObjRefData gSource "target"))
						(block (theTarget delayTime theStar)
							; Tell the player
							(plyMessage gPlayer (objGetName aObjDestroyed 0x01) " destroyed!")
							
							; Pick a new target for the sentinels
							(setq theTarget (random (filter (sysFindObject Nil "TA +hereticStation;") theObj (not (eq theObj aObjDestroyed)))))
							(if (and (not theTarget) gPlayerShip)
								(setq theTarget gPlayerShip)
								)
							
							(if theTarget
								(block Nil
									; Retarget sentinels
									(setq delayTime (random 20 60))
									(setq theStar (sysFindObject Nil "tN +star;"))
									(enum (sysFindObject Nil "sD:attackForce") theSentinel
										(block Nil
											; Orbit for a bit to give the player a chance
											(shpOrder theSentinel 'orbit theStar 360 delayTime)
											
											; Attack next target
											(shpOrder theSentinel 'attack theTarget)
											)
										)
										
									(objRegisterForEvents gSource theTarget)
									(objSetObjRefData gSource "target" theTarget)
									(objSetData gSource "attackStatus" 'inProgress)
									;(dbgOutput "Deploying sentinels to " (objGetName theTarget 0x00))
									)
									
								; No target
								(block Nil
									(objSetData gSource "attackStatus" Nil)
									)
								)
							)
							
					; If a sentinel was destroyed, then decrement the count
					; If all sentinels destroyed, wait a bit before next attack
					(objGetData aObjDestroyed "attackForce")
						(if (eq (objIncData gSource "sentinelCount" -1) 0)
							(block Nil
								; Clear the destination target
								(objClearShowAsDestination (objGetObjRefData gSource "target"))
								(objSetObjRefData gSource "target" Nil)
								
								; Increase the squadron size
								(if (leq (random 1 100) 25)
									(objIncData gSource "squadronSize" 1)
									)
								
								; Wait a bit before the next attack. 
								(objSetData gSource "attackStatus" 'waiting)
								
								; We wait ~40 * 90 ticks (2 minutes) or 80 * 90 ticks
								; if all iocrym outposts are destroyed
								(objSetData gSource "attackTimer"
									(if (sysFindObject Nil "TA +iocrymOutpost;")
										(random 34 46)
										(random 68 92)
										)
									)
									
								;(dbgOutput "All sentinels destroyed")
								)
							)
								
					; If an Iocrym outpost was destroyed, then begin attack
					(objMatches aObjDestroyed gSource "T +iocrymOutpost;")
						(herStatusSet 'sentinelAttack)
					)
			</OnObjDestroyed>
			
			<OnObjDocked>
				(if (and (eq aObjDocked gPlayerShip) 
						(eq aDockTarget (objGetObjRefData gSource "dockTarget")))
					(block Nil
						(shpCancelOrders gPlayerShip)
						(objUnregisterForEvents gSource gPlayerShip)
						(objSetObjRefData gSource "dockTarget" Nil)
						)
					)
			</OnObjDocked>
			
			<OnSentinelAttack>
				(block (status)
					(setq status (objGetData gSource "attackStatus"))
					
					(switch
						; See if we should launch a new attack
						(not status)
							(if (and (herStatus 'sentinelAttack) (not (herStatus 'quarantineLifted)) gPlayerShip)
								(block (theTarget theBase theCount squadronSize)
									; Pick a random base (if none is left, attack the player)
									(setq theTarget (random (sysFindObject Nil "TA +hereticStation;")))
									(if (not theTarget)
										(setq theTarget gPlayerShip)
										)
										
									; Pick a random Iocrym outpost (if none is left, start from commandship)
									(setq theBase (random (sysFindObject Nil "TA +iocrymOutpost;")))
									(if (not theBase)
										(setq theBase (sysFindObject gSource "sN +iocrymCommandShip;"))
										)
										
									; Figure out how many sentinels we should send
									(setq squadronSize (objGetData gSource "squadronSize"))
									(setq theCount (random squadronSize (add squadronSize 1)))
									(if (not (sysFindObject Nil "TA +iocrymOutpost;"))
										(setq theCount (add theCount 3))
										)
										
									; Send them all
									(for i 1 theCount
										(block (theSentinel)
											(setq theSentinel (sysCreateShip &scIocrymSentinel; theBase &svIocrym;))
											(shpOrder theSentinel 'attack theTarget)
											
											; Small chance that a sentinel has some useful research data
											; (we do this so there is always some hope of getting enough data)
											(if (leq (random 1 100) 5)
												(objAddItem theSentinel (itmCreate &itIocrymSentinelData; 1))
												)
											
											(objSetData theSentinel "attackForce" True)
											(objRegisterForEvents gSource theSentinel)
											)
										)
										
									; Set the count
									(objIncData gSource "sentinelCount" theCount)
									
									; Register the target
									(objRegisterForEvents gSource theTarget)
									(objSetObjRefData gSource "target" theTarget)
									
									; Done
									(objSetData gSource "attackStatus" 'inProgress)
									;(dbgOutput "Deploying " theCount " sentinels to " (objGetName theTarget 0x00))
									)
								)
								
						(eq status 'inProgress)
							(block (theTarget)
								(if (and (not (eq (setq theTarget (objGetObjRefData gSource "target")) gPlayerShip))
										(sysFindObject theTarget "s N:300; D:attackForce")
										)
									(block Nil
										(plyMessage gPlayer (objGetName theTarget 0x05) " is under attack!")
										(objSetShowAsDestination theTarget Nil 'autoclear)
										(objSetData gSource "attackStatus" 'distressSignal)
										)
									)
								)
								
						(eq status 'waiting)
							(if (eq (objIncData gSource "attackTimer" -1) 0)
								(objSetData gSource "attackStatus" Nil)
								)
						)
					)
			</OnSentinelAttack>
		</Events>

		<DockScreens>
			<Main>

				<InitialPane>
					(switch
						(typGetGlobalData &scSvalbardExplorer; "inTransfer")
							"TransferSvalbardCrew"

						"Default"
						)
				</InitialPane>

				<Panes>
					<Default>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You are docked at a massive alien structure. The walls appear to be made of a "
								"blue-green crystaline substance that looks fragile but is actually immensely strong."
								(if (herStatus 'controlPointCamp)
									(cat
										"\n\nCables and equipment run through the dock area into a large central chamber "
										"in front of you. You see researchers working in the distance."
										)
									""
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Central Chamber" default="1" key="C">
								(block (status)
									(setq status (objGetData gSource "status"))
									(switch
										(eq status 'disabled)
											(if (objGetItems gPlayerShip "* +HereticROM; -LesserData;")
												(scrShowPane gScreen "GetSentinelVirus")
												(scrShowPane gScreen "Disabled")
												)

										(not (herStatus 'controlPointCamp))
											(scrShowPane gScreen "Deserted")

										(geq (typGetGlobalData &scSvalbardExplorer; "researchStatus") 3)
											(scrShowPane gScreen "DisableManipulators")

										(not status)
											(scrShowPane gScreen "Intro")

										(objGetItems gPlayerShip "* +HereticROM;")
											(scrShowPane gScreen "Research")
											
										(and (not (objGetObjRefData gSource "dockTarget")) 
												(filter (sysFindObject Nil "TF") theObj	(objGetItems theObj "* +HereticROM;"))
												)
											(scrShowPane gScreen "FindResearch")
											
										(and (herStatus 'missionMRAD)
												(herStatus 'missionMaryamsArchive)
												(herStatus 'missionHuygensExplorer)
												(herStatus 'missionTaikon)
												)
											(scrShowPane gScreen "WaitForResearch")

										(scrShowPane gScreen "MoreResearchNeeded")
										)
									)
							</Action>

							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Default>

					<Deserted>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"The central chamber is deserted, but the entire structure seems to hum with power. "
								"Built in to the walls of the chamber you see banks of alien machines covered in "
								"glowing symbols."
								))
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</Deserted>

					<Disabled>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"Researchers have connected their scanners and computers to the alien machines "
								"in the chamber. A researcher talks to you:\n\n"
								"\"Now that we've disabled the Iocrym manipulators we have a little more time "
								"to study this technology. We're going to make some amazing discoveries here! "
								"Maybe someday soon we'll be as advanced as the Iocrym!\""
								))
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</Disabled>

					<Intro>
						<OnPaneInit>
							(scrSetDesc gScreen
								"Kate Morgental and her team from the Svalbard Explorer are setting up "
								"a research base here. Their goal is to understand how to break the Iocrym "
								"quarantine."
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(objSetData gSource "status" 'introComplete)
									(switch
										(not (herStatus 'sentinelAttack))
											(scrShowPane gScreen "SentinelAttack")
											
										(objGetItems gPlayerShip "* +HereticROM;")
											(scrShowPane gScreen "Research")

										(scrShowPane gScreen "Default")
										)
									)
							</Action>
						</Actions>
					</Intro>
					
					<SentinelAttack>
						<OnPaneInit>
							(scrSetDesc gScreen
								"Kate Morgental approaches you:\n\n"
								"\"It looks like the Iocrym know that we're here. We've been monitoring the outer "
								"system and we've detected Iocrym activity. We think they are planning to attack us\x97"
								"but we don't know what their target will be. Stay sharp: we'll send a message out "
								"to you if anything happens.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(herStatusSet 'sentinelAttack)
									
									(switch
										(objGetItems gPlayerShip "* +HereticROM;")
											(scrShowPane gScreen "Research")

										(scrShowPane gScreen "Default")
										)
									)
							</Action>
						</Actions>
					</SentinelAttack>

					<Research>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"You tell Kate Morgental that you have research data on the Iocrym. She and her "
								"team are happy:\n\n"
								"\"That's wonderful\x97we'll analyze the data and see if it can help us to "
								"break the Iocrym quarantine. Wait here while we take a look.\""
								))
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block (research romsNeeded)
									(setq research (typGetGlobalData &scSvalbardExplorer; "researchStatus"))
									
									; Count the number of research ROMs
									(setq romsNeeded (subtract QUARANTINE_RESEARCH_NEEDED research))
									
									(enum (objGetItems gPlayerShip "* +HereticROM;") theROM
										(block (romsUsed)
											(setq romsUsed (min romsNeeded (itmGetCount theROM)))
											(if (gr romsUsed 0)
												(block Nil
													(setq research (add research romsUsed))
													(setq romsNeeded (subtract romsNeeded romsUsed))
													(objRemoveItem gPlayerShip theROM romsUsed)
													)
												)
											)
										)

									; Update
									(typSetGlobalData &scSvalbardExplorer; "researchStatus" research)

									; Result
									(if (geq research QUARANTINE_RESEARCH_NEEDED)
										(scrShowPane gScreen "ResearchComplete")
										(scrShowPane gScreen "ResearchThanks")
										)
									)
							</Action>
						</Actions>
					</Research>

					<ResearchThanks>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"\"Thank you! The data that your provided is very useful. We are closer to "
								"understanding how the quarantine works, but we still don't know how to disable it. "
								"If you can get us more data, that would help a lot.\""
								))
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</ResearchThanks>

					<ResearchComplete>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"\"That's it! That's the missing piece! With all the data you've gathered we "
								"now understand how the Iocrym have created the quarantine. The event horizon that "
								"keeps us from leaving will collapse as soon as we disable the Iocrym manipulators "
								"deployed around the Heretic sun.\""
								))
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(scrShowPane gScreen "DisableManipulators")
							</Action>
						</Actions>
					</ResearchComplete>

					<DisableManipulators>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"\"All of the Iocrym manipulators are controlled from this position. We should be able "
								"to order the manipulators to shut down\x97that will break the quarantine! Stand by...\""
								))
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(scrShowPane gScreen "DisableManipulators2")
							</Action>
						</Actions>
					</DisableManipulators>

					<DisableManipulators2>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"Kate Morgental's team connects their equipment to the alien machinery. They issue commands "
								"and the alien symbols around the chamber begin to flash in unison. Suddenly, the omnipresent "
								"hum of gigantic machinery changes pitch and begins to die down."
								))
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(scrShowPane gScreen "DisableManipulators3")
							</Action>
						</Actions>
					</DisableManipulators2>

					<DisableManipulators3>
						<OnPaneInit>
							(scrSetDesc gScreen (cat
								"\"We've done it! The quarantine is broken! I'll get a message to St. Kat's\x97this "
								"is a historic moment for the human race!\n\n"
								"\"Now you're free to continue your journey to the Core. Thanks for your help, %name%. "
								"We couldn't have done it without you. I hope to see you again someday.\""
								))
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(objSetData gSource "status" 'disabled)
									(herStatusSet 'quarantineLifted)
									
									(if (objGetItems gPlayerShip "* +HereticROM; -LesserData;")
										(scrShowPane gScreen "GetSentinelVirus")
										(scrShowPane gScreen "Default")
										)
									)
							</Action>
						</Actions>
					</DisableManipulators3>
					
					<FindResearch>
						<OnPaneInit>
							(scrSetDesc gScreen
								"Kate Morgental approaches you:\n\n"
								"\"Good to see you again! We're making progress, but we need more data. Fortunately, "
								"we've identified a wreck in the system that has the research data we need. "
								"Will you go retrieve it?\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="&quot;Tell me how to find it.&quot;" default="1" key="T">
								(block (theWreck)
									(setq theWreck
										(random 
											(filter (sysFindObject Nil "TF") theObj	(objGetItems theObj "* +HereticROM;"))
											)
										)
									
									(shpCancelOrders gPlayerShip)
									(shpOrder gPlayerShip 'dock theWreck)
									
									(objSetObjRefData gSource "dockTarget" theWreck)
									(objRegisterForEvents gSource gPlayerShip)
									
									(scrShowPane gScreen "FindResearch2")
									)
							</Action>
							
							<Action name="&quot;Sorry, I'm busy.&quot;" cancel="1" key="S">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</FindResearch>
					
					<FindResearch2>
						<OnPaneInit>
							(scrSetDesc gScreen
								"\"Thanks. We've programmed the location of the wreck into your computer. "
								"Find the wreck and bring the data it contains back to us.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								<Exit/>
							</Action>
						</Actions>
					</FindResearch2>
					
					<WaitForResearch>
						<OnPaneInit>
							(scrSetDesc gScreen
								"Kate Morgental approaches you. She looks tired and frustrated:\n\n"
								"\"It's no use! We don't have enough data to figure out how to disable the quarantine. "
								"And the other research stations have either been destroyed or come up with nothing. "
								"Our only hope is to catch a break from some Iocrym hardware. Maybe we can "
								"salvage some data out of the wreck of an Iocrym sentinel.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</WaitForResearch>
					
					<MoreResearchNeeded>
						<OnPaneInit>
							(scrSetDesc gScreen
								"Kate Morgental and her researchers are studying the alien machinery. She approaches:\n\n"
								"\"We're slowly making progress, but we need more data. Go talk to the other stations "
								"in the system and see if they have any research data that might help us.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Done" default="1" cancel="1" key="D">
								(scrShowPane gScreen "Default")
							</Action>
						</Actions>
					</MoreResearchNeeded>
					
					<GetSentinelVirus>
						<OnPaneInit>
							(scrSetDesc gScreen
								"You tell Kate's scientists that you have additional data on the Iocrym. The scientists analyze the data:\n\n"
								"\"With this research data we have been able to create an infiltration virus that can disable the "
								"Iocrym sentinels that have been attacking us. Take these mnemonic cubes and use them "
								"if your ship has a quantum CPU.\""
								)
						</OnPaneInit>
						
						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block (romCount cubeCount)
									; Count the number of research ROMs
									(setq romCount 0)
									(enum (objGetItems gPlayerShip "* +HereticROM;") theROM
										(block Nil
											(setq romCount (add romCount (itmGetCount theROM)))
											(objRemoveItem gPlayerShip theROM)
											)
										)

									(setq cubeCount 0)
									(for i 1 romCount
										(setq cubeCount (add cubeCount (random 2 4)))
										)

									; Create mnemonic cubes
									(objAddItem gPlayerShip (itmCreate &itIocrymSentinelVirus; cubeCount))
									
									; Done
									(scrShowPane gScreen "Default")
									)
							</Action>
						</Actions>
					</GetSentinelVirus>

					<TransferSvalbardCrew>
						<OnPaneInit>
							(scrSetDesc gScreen
								"Kate Morgental disembarks with her research team:\n\n"
								"\"Thanks for bringing us here; our whole mission would have failed without you. "
								"Fortunately we were able to salvage a lot of our equipment from the Svalbard.\""
								)
						</OnPaneInit>

						<Actions>
							<Action name="Continue" default="1" cancel="1" key="C">
								(block Nil
									(shpCancelOrders gPlayerShip)
									(typSetGlobalData &scSvalbardExplorer; "inTransfer" Nil)
									(herStatusSet 'controlPointCamp)

									(objSetData gSource "status" 'introComplete)
									(switch
										(objGetItems gPlayerShip "* +HereticROM;")
											(scrShowPane gScreen "Research")

										(scrShowPane gScreen "MoreResearchNeeded")
										)
									)
							</Action>
						</Actions>
					</TransferSvalbardCrew>
				</Panes>
			</Main>

		</DockScreens>

		<DockingPorts>
			<Port x="-36"	y="80" />
			<Port x="-87"	y="40" />
			<Port x="-92"	y="-33" />
			<Port x="-42"	y="-85" />
			<Port x="36"	y="80" />
			<Port x="87"	y="40" />
			<Port x="92"	y="-33" />
			<Port x="42"	y="-85" />
		</DockingPorts>
	</StationType>

	<!-- Iocrym Manipulator

	EXTRA DATA

	fireAngle:			Fire angle for the energy pulse

	-->

	<StationType UNID="&stIocrymManipulator;"
			name=				"Iocrym manipulator"
			sovereign=			"&svIndependent;"
			dockScreen=			"Main"
			dockingPorts=		"4"
				 
			attributes=			"alien, iocrym"

			multiHull=			"true"
			immutable=			"true"
			>

		<ImageVariants>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="0"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="192"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="384"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="576"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="768"	imageWidth="192" imageHeight="192"/>

			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="960"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="1152"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="1344"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="1536"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="1728"	imageWidth="192" imageHeight="192"/>

			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="1920"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="2112"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="2304"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="2496"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="2688"	imageWidth="192" imageHeight="192"/>

			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="2880"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="3072"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="3264"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="3456"	imageWidth="192" imageHeight="192"/>
			<Image imageID="&rsIocrymManipulator;" imageX="0" imageY="3648"	imageWidth="192" imageHeight="192"/>
		</ImageVariants>

		<DockScreens>
			<Main>

				<Panes>
					<Default>
						<OnPaneInit>
							(switch
								(herStatus 'quarantineLifted)
									(scrSetDesc gScreen
										"You are docked at an Iocrym structure of immense size. "
										"Though it has fortunately been deactivated, its purpose was to warp the gravity well around the Heretic sun "
										"and prevent anyone from leaving the inner system."
										)
										
								(scrSetDesc gScreen
									"You are docked at an alien structure of immense size. "
									"Vast energies pulse through its core and a massive beam of incredible power erupts regularly out of one end. "
									"You feel a dizzying vertigo just being near it."
									)
								)
						</OnPaneInit>

						<Actions>
							<Action name="Undock" cancel="1" key="U">
								<Exit/>
							</Action>

						</Actions>

					</Default>
				</Panes>
			</Main>

		</DockScreens>

		<Events>
			<OnCreate>
				(sysAddObjRecurringTimerEvent 150 gSource "OnFirePulse")
			</OnCreate>

			<OnFirePulse>
				(if (not (herStatus 'quarantineLifted))
					(sysCreateWeaponFire
						&itIocrymManipulator;
						gSource
						(objGetPos gSource)
						(objGetData gSource "fireAngle")
						50
						Nil
						)
					)
			</OnFirePulse>
		</Events>

	</StationType>

	<!-- Heretic Sun -->

	<StationType UNID="&stHereticSun;"
			name=				"Heretic"
			scale=				"star"
			sovereign=			"&svIndependent;"

			attributes=			"star"
				 
			spaceColor=			"#495167"
			maxLightRadius=		"610"
			>
		
		<ImageEffect>
			<Orb
					style=			"smooth"
					radius=			"490"
					intensity=		"25"
					primaryColor=	"#a6beff"
					secondaryColor=	"#a6beff"
					/>
		</ImageEffect>
		
		<Events>
			<OnCreate>
				(sysAddObjRecurringTimerEvent 30 gSource "OnEffect")
			</OnCreate>

			<OnEffect>
				(if (not (herStatus 'quarantineLifted))
					(sysCreateEffect &efIocrymManipulatorWaves; gSource Nil)
					)
			</OnEffect>
		</Events>
	</StationType>

	<Effect UNID="&efIocrymManipulatorWaves;">
		<Shockwave
				style=			"glowRing"
				lifetime=		"40"
				speed=			"20"
				
				width=			"2"
				glowSize=		"12"
				fadeStart=		"0"
				primaryColor=	"0xff, 0xc0, 0xff"
				secondaryColor=	"0xff, 0x80, 0xff"
				/>
	</Effect>

	<!-- Space Environments -->

	<SpaceEnvironmentType UNID="&seSpacetimeQuarantine;"
			lrsJammer=			"true"
			dragFactor=			"73"
			attributes=			"nebula"

			mapColor=			"#be83ac"
			autoEdges=			"true"
			>

		<Image imageID="&rsLightNebula;" 
				imageX="0" 
				imageY="0" 
				imageWidth="2048" 
				imageHeight="2048"/>

		<Events>
			<OnObjUpdate>
				(block (thePos theAngle theRadius)
					(setq thePos (objGetPos aObj))
					(setq theRadius (sysVectorDistance thePos))
					(if (and (gr theRadius QUARANTINE_RADIUS)	(not (herStatus 'quarantineLifted)))
						(block Nil
							(setq theAngle (sysVectorAngle thePos))
							(objSetPos aObj (sysVectorPolarOffset Nil (add theAngle 180) (subtract QUARANTINE_RADIUS 10)))
							)
						)
					)
			</OnObjUpdate>
		</Events>
	</SpaceEnvironmentType>

	<!-- Heretic System -->

	<SystemType UNID="&ssHeretic;" 
			backgroundID=		"&rsLightNebulaSpace;"
			spaceEnvironmentTileSize=	"large"
			noRandomEncounters=	"true"
			noExtraEncounters=	"true"
			>

		<Tables>
			<!-- Planets and Asteroids -->

			<InnerArcMedium>
				<Group>
					<Siblings count="2d20" arcInc="2d205-206" radiusInc="-4-4">
						<Lookup table="InnerAsteroid"/>
					</Siblings>

					<Siblings count="2d20" arcInc="2d159-160" radiusInc="-6-6">
						<Lookup table="InnerAsteroid"/>
					</Siblings>

					<Siblings count="2d16" arcInc="2d109-110" radiusInc="-8-8">
						<Lookup table="InnerAsteroid"/>
					</Siblings>

					<Siblings count="2d12" arcInc="2d49-50" radiusInc="-12-12">
						<Lookup table="InnerAsteroid"/>
					</Siblings>
				</Group>
			</InnerArcMedium>

			<InnerArcSmall>
				<Group>
					<Siblings count="2d12" arcInc="2d105-106" radiusInc="-3-3">
						<Lookup table="InnerAsteroid"/>
					</Siblings>

					<Siblings count="2d12" arcInc="2d79-80" radiusInc="-4-4">
						<Lookup table="InnerAsteroid"/>
					</Siblings>

					<Siblings count="2d10" arcInc="2d54-55" radiusInc="-6-6">
						<Lookup table="InnerAsteroid"/>
					</Siblings>

					<Siblings count="2d8" arcInc="2d24-25" radiusInc="-9-9">
						<Lookup table="InnerAsteroid"/>
					</Siblings>
				</Group>
			</InnerArcSmall>

			<InnerAsteroid>
				<Table>
					<Station chance="45" type="&stMetallicAsteroidSizeA;"/>
					<Station chance="45" type="&stRockyAsteroidSizeA;"/>
					<Station chance="5" type="&stMetallicAsteroidSizeB;"/>
					<Station chance="5" type="&stRockyAsteroidSizeB;"/>
				</Table>
			</InnerAsteroid>
		</Tables>

		<SystemGroup>

			<!-- Star -->
			
			<Station type="&stHereticSun;" name="1766 Zhang"/>

			<AddAttribute attributes="GTypeSystem"/>
			<AddTerritory minRadius="0"		maxRadius="370"		attributes="innerSystem, rockyComp, cinderZone"/>
			<AddTerritory minRadius="370"	maxRadius="620"		attributes="lifeZone, rockyComp, desertZone"/>
			<AddTerritory minRadius="620"	maxRadius="0"		attributes="outerSystem, rockyComp, frostZone"/>
			
			<!-- Control Center -->

			<Orbitals distance="90" angle="90">
				<Station type="&stHereticControlCenter;"/>
			</Orbitals>

			<!-- Pteravore lairs around the manipulators -->

			<Orbitals count="3d2" distance="65-80" angle="minSeparation:10">
				<Station type="&stPteravoreLair;"/>
			</Orbitals>

			<!-- Archipelago -->

			<Orbitals distance="4" scale="light-minute" angle="random">
				<Group>
					<Station chance="5" type="&stRockyAsteroidSizeB;"/>

					<Siblings count="6d4+1" angle="equidistant" radiusInc="-120-120">
						<Group>
							<Table>
								<Lookup chance="75" table="InnerArcSmall"/>
								<Lookup chance="25" table="InnerArcMedium"/>
							</Table>

							<Siblings arcInc="-60-60" radiusInc="8-16">
								<Label attributes="archipelago, asteroids"/>
							</Siblings>
						</Group>
					</Siblings>
				</Group>
			</Orbitals>

			<!-- Place the stations around the archipelago -->

			<RandomLocation locationCriteria="*archipelago">
				<Group>
					<Lookup table="StargateInbound"/>
					<Orbitals distance="18-24" angle="random">
						<Station type="&stHereticStation;"/>
					</Orbitals>
				</Group>
				<Station type="&stCommonwealthResearchHeretic;"/>
				<Station type="&stSvalbardEncounter;"/>
				<Station type="&stRingersResearchHeretic;"/>
				<Station type="&stSistersResearchHeretic;"/>
				<Station type="&stTVX1Outpost;"/>
				<Station type="&stAresResearchHeretic;"/>
			</RandomLocation>

			<!-- Heretic II -->

			<Orbitals distance="8" scale="light-minute" angle="random">
				<Group>
					<Station type="&stRockyPlanetoidSizeE;"
							showOrbit="true"
							/>

					<Siblings count="4d4+8" distribution="4d40-82">
						<Station type="&stRockyAsteroidSizeA;"/>
					</Siblings>
				</Group>
			</Orbitals>

			<!-- Nebula -->

			<Orbitals count="2d4" distance="300-420" angle="random">
				<SpaceEnvironment 
						type=			"&seLightNebula;"
						shape=			"arc" 
						width=			"60"
						widthVariation=	"100"
						span=			"1d40+50"
						erode=			"50"

						patchType=		"&efNebula;"
						patchFrequency=	"50"

						encountersCount="1d4+2"
						>
					<Label attributes="brightNebulae, innerNebula, nebulae, void"/>
				</SpaceEnvironment>
			</Orbitals>

			<Orbitals count="2d4" distance="780-880" angle="random">
				<SpaceEnvironment 
						type=			"&seLightNebula;"
						shape=			"arc" 
						width=			"60"
						widthVariation=	"100"
						span=			"1d40+50"
						erode=			"50"

						patchType=		"&efNebula;"
						patchFrequency=	"50"

						encountersCount="1d4+2"
						>
					<Label attributes="brightNebulae, outerNebula, nebulae, void"/>
				</SpaceEnvironment>
			</Orbitals>

			<Orbitals distance="960" angle="random">
				<SpaceEnvironment 
						type=			"&seSpacetimeQuarantine;"
						shape=			"circular" 
						width=			"120"
						widthVariation=	"50"
						>
				</SpaceEnvironment>
			</Orbitals>
			
			<!-- Some Iocrym outposts are hidden in the nebula -->
			
			<RandomLocation count="1d4" locationCriteria="*outerNebula">
				<Station type="&stIocrymOutpost;"/>
			</RandomLocation>

			<!-- Heretic III -->

			<Orbitals distance="24" scale="light-minute" angle="random">
				<Group>
					<Station type="&stRockyPlanetoidSizeG;" 
							name="Heretic III" 
							showOrbit="true"
							/>

					<Orbitals distance="2d12" angle="random">
						<Stargate objName="Outbound" type="&stHereticGate;">
							<Ships>
								<Ship	class="&scIocrymCommandShip;" count="1" sovereign="&svIocrym;" orders="patrol" patrolDist="20">
									<Items>
										<Item count="1" item="&itStargateControlRod;"/>
									</Items>
								</Ship>
							</Ships>
						</Stargate>
					</Orbitals>
				</Group>
			</Orbitals>

		</SystemGroup>

		<Events>
			<OnCreate>
				(block (objCount angularSep radius theAngle varCount varOffset varAngle)

					; Create manipulators around central star
					(setq angularSep 18)
					(setq radius 60)

					(setq varCount 20)
					(setq varOffset (multiply (divide varCount 4) 3))
					(setq varAngle (divide 360 varCount))
					(setq objCount (divide 360 angularSep))

					(setq theAngle 0)
					(for i 1 objCount
						(block (theObj)
							(setq theObj 
								(sysCreateStation &stIocrymManipulator; (sysVectorPolarOffset Nil theAngle radius)))

							; Variant
							(staSetImageVariant theObj
								(modulo
									(subtract varCount (modulo (add (divide theAngle varAngle) varOffset 10) varCount))
									varCount
									)
								)

							; Set the fire angle
							(objSetData theObj "fireAngle" (modulo (add theAngle 180) 360))

							; Do not show a map label
							(staSetShowMapLabel theObj Nil)

							; Next
							(setq theAngle (add theAngle angularSep))
							)
						)
					)
			</OnCreate>
			
			<OnObjJumpPosAdj>
				(block Nil
					; Do not allow the player to jump outside of the quarantine
					
					(if (not (herStatus 'quarantineLifted))
						(block (theRadius)
							(setq theRadius (sysVectorDistance aJumpPos))
							(if (gr theRadius QUARANTINE_RADIUS)
								(setq aJumpPos (sysVectorPolarOffset Nil (add (sysVectorAngle aJumpPos) 180) (subtract (add QUARANTINE_RADIUS QUARANTINE_RADIUS -10) theRadius)))
								)
							)
						)
						
					aJumpPos
					)
			</OnObjJumpPosAdj>
		</Events>

	</SystemType>

	<!-- Globals -->

	<Globals>
		(block Nil
			(setq QUARANTINE_RADIUS 940)
			(setq QUARANTINE_RESEARCH_NEEDED 3)
			
			(setq arcQuestionHandler (lambda (qIndex)
				(block (theQ)
					(setq theQ (item gQuestions qIndex))
					(objSetData gSource "theAnswer" (eval (item theQ 4)))
					(objSetData gSource "usedQuestions" 
						(append
							(objGetData gSource "usedQuestions")
							(item theQ 0)
							)
						)
						
					(switch
						(eq (item theQ 0) 'q2)
							(block Nil
								(objAddItem gPlayerShip (itmCreate &itHereticResearchROM; 1))
								(herStatusClear 'currentMission)
								(herStatusSet 'missionMaryamsArchive 'success)
								)
						)
						
					(scrShowPane gScreen "Default")
					)
				))
				
			(setq herAttackInProgress (lambda (theStation)
				(sysFindObject theStation "sAE N:60; O:attack;")
				))
				
			; controlPointCamp:			Control point camp established
			; currentMission:			Current mission in progress
			; missionAres:				Ares mission successful
			; missionHuygensExplorer:	Huygens Explorer destroyed
			; missionMaryamsArchive:	AI has given info to player
			; missionMRAD:				MRAD experiment successfull
			; missionSvalbardExplorer:	Svalbard Explorer completed its run
			; missionTaikon:			Iocrym cybernetic tower found
			; quarantineLifted:			Quarantine field enabled
			; sentinelAttack:			Sentinels are attacking stations

			(setq herStatus (lambda (statusField)
				(typGetGlobalData &scSvalbardExplorer; statusField)
				))
				
			(setq herStatusClear (lambda (statusField)
				(typSetGlobalData &scSvalbardExplorer; statusField Nil)
				))
				
			(setq herStatusSet (lambda (statusField theValue)
				(block Nil
					(if (not theValue)
						(setq theValue True)
						)
					(typSetGlobalData &scSvalbardExplorer; statusField theValue)
					)
				))
				
			(setq mradDisplay (lambda (probeObj anomalyPos displayField)
				(block (dist)
					(switch
						(eq displayField 'shipDistance)
							(if probeObj
								(sysVectorDistance gPlayerShip probeObj)
								""
								)

						(eq displayField 'shipBearing)
							(if probeObj
								(modulo (add 90 (subtract 360 (sysVectorAngle (sysVectorSubtract gPlayerShip probeObj)))) 360)
								""
								)

						(eq displayField 'anomalyDistance)
							(switch
								(not probeObj)
									""
								(leq (setq dist (sysVectorDistance anomalyPos probeObj)) 500)
									dist
								"???"
								)

						(eq displayField 'anomalyBearing)
							(switch
								(not probeObj)
									""
								(leq (sysVectorDistance anomalyPos probeObj) 75)
									(modulo (add 90 (subtract 360 (sysVectorAngle (sysVectorSubtract anomalyPos probeObj)))) 360)
								"???"
								)

						(eq displayField 'dataDownload)
							(switch
								(not probeObj)
									""
								(leq (sysVectorDistance anomalyPos probeObj) 10)
									(random 75 99)
								"0"
								)

						""
						)
					)
				))
			)
	</Globals>

<!-- Resources -->

	<Image UNID="&rsMRADProbe;"			bitmap="Resources\MRADProbe.jpg" bitmask="Resources\MRADProbeMask.bmp" loadOnUse="true"/>
	<Image UNID="&rsIocrymManipulator;"	bitmap="Resources\IocrymManipulator.jpg" bitmask="Resources\IocrymManipulatorMask.bmp" loadOnUse="true"/>
	
	<Image UNID="&rsCorporateExplorer;"	bitmap="Resources\CorporateExplorer.jpg" bitmask="Resources\CorporateExplorerMask.bmp" loadOnUse="true"/>

	<Image UNID="&rsMRADConsole;"		bitmap="Resources\MRADConsole.jpg" bitmask="Resources\MRADConsoleMask.bmp" loadOnUse="true"/>
	<Image UNID="&rsHereticItems;"		bitmap="Resources\HereticItems.jpg" bitmask="Resources\HereticItemsMask.bmp" />

</TranscendenceModule>
