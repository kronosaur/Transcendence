<?xml version="1.0" ?>

<TranscendenceModule>

	<!-- Mission: Juan Carlos mission ==========================================		

	EXTRA DATA

	reward:			Reward (in credits) for completing mission
	missionXP:		XP awarded for completing mission
	juanID:			ID of Juan Carlos' ship.

	status:			Mission status:
		Nil:		Player going out to meet Juan Carlos
		'decoy:		Player has the ROM and Juan is fighting Ares
		'leaving:	Juan has thanked the player and is leaving the system

	======================================================================== -->

	<MissionType UNID="&msCSCCollectDataROM;"
			name=			"Collect Lamplighter ROM"
			attributes=		"commonwealthFleet, cscTaskForce, rank1, lamplighter"

			level=			"5-8"
			maxAppearing=	"1"

			expireTime=		"5400"
			failureAfterOutOfSystem="5400"
			>

		<Events>
			<OnCreate>
				(block
					(msnSetData gSource 'missionXP 100)
					)
			</OnCreate>

			<OnAccepted>
				(block (
					(stationObj (objGetObjByID (msnGetProperty gSource 'ownerID)))
					juanObj
					)

					;	Create Juan Carlos' ship some place relatively safe
					(setq juanObj
						(rpgCharacterCreateShip
							&unidJuanCarlos;
							&scEI500JuanCarlos;
							(sysVectorRandom gSource (random 240 400) 60 "Ts")
							{ repairAll:True }
							)
						)
					(shpCancelOrders juanObj)
					(shpOrder juanObj 'hold)
					
					(msnRegisterForEvents gSource juanObj)
					(msnSetData gSource 'juanID (objGetID juanObj))

					;	Set the proper screen
					(rpgCharacterSetScreen 
						&unidJuanCarlos;
						{	screen: &dsRPGDialog;
							translateType: &msCSCCollectDataROM;
							translateID: 'JuanCarlosMeeting
							}
						)

					;	Sometimes the freighter is under attack
					(if (leq (random 1 100) 50)
						(sysAddEncounterEventAtDist 0 juanObj &etAresAmbush1; (objGetDistance stationObj juanObj))
						)

					;	Track player
					(msnRegisterForEvents gSource gPlayerShip)
					)
			</OnAccepted>

			<OnObjDestroyed>
				(switch
					;	We don't care if an object ascends or enters a stargate				
					(or (= aDestroyReason 'ascended) (= aDestroyReason 'enteredStargate))
						Nil

					;	If Juan dies before we get the ROM, the mission fails.
					(= (objGetID aObjDestroyed) (msnGetData gSource 'juanID))
						(block Nil
							(rpgCharacterSetStatus &unidJuanCarlos; 'dead)

							(if (not (msnGetData gSource 'status))
								(msnFailure gSource)
								)
							)
					)
			</OnObjDestroyed>

			<OnObjDocked>
				(if (and	(msnGetData gSource 'status)
							(= aObjDocked gPlayerShip)
							(= (objGetID aDockTarget) (msnGetProperty gSource 'ownerID))
							)
					;	If player docks with CSC then mission completes
					(if (objGetItems gPlayerShip "*UN +unid:&itLamplighterDataROM;;")
						(block Nil
							;	Take the item
							(objEnumItems gPlayerShip "*UN +unid:&itLamplighterDataROM;;" theItem
								(objRemoveItem gPlayerShip theItem)
								)

							(msnSuccess gSource)
							)
						
						;	If we have lost the ROM, then fail
						(msnFailure gSource)
						)
					)
			</OnObjDocked>

			<OnSetPlayerTarget>
				(switch
					;	If we have the ROM then return to CSC
					(msnGetData gSource 'status)
						(rpgSetTarget gSource aReason (objGetObjByID (msnGetProperty gSource 'ownerID)) 'dock)

					; Otherwise rendezvous with Juan Carlos
					(rpgSetTarget gSource aReason (objGetObjByID (msnGetData gSource 'juanID)) 'dock)
					)
			</OnSetPlayerTarget>

			<OnAresAttack>
				(block (
					(missionObj (@ (msnFind "a +unid:&msCSCCollectDataROM;;") 0))
					(juanObj (objGetObjByID (msnGetData missionObj 'juanID)))
					)

					;	Give data ROM to player
					(objAddItem gPlayerShip (itmCreate &itLamplighterDataROM; 1))

					;	Create Ares to attack Juan Carlos and player
					(sysAddEncounterEventAtDist 0 juanObj &etAresAmbush2; (random 100 130))
					(sysAddEncounterEventAtDist 0 gPlayerShip &etAresAmbush2; (random 100 130))

					;	Juan Carlos stays for a while
					(shpCancelOrders juanObj)
					(shpOrder juanObj 'hold (random 120 180))
					(shpOrder juanObj 'gate)
					
					;	Set the proper screen
					(rpgCharacterSetScreen 
						&unidJuanCarlos;
						{	screen: &dsRPGDialog;
							translateType: &msCSCCollectDataROM;
							translateID: 'JuanCarlosThanks
							}
						)

					;	Update mission status and send player back to CSC
					(msnSetData missionObj 'status 'decoy)
					(msnSetPlayerTarget missionObj)
					)
			</OnAresAttack>

			<OnJuanLeaves>
				(block (
					(missionObj (@ (msnFind "a +unid:&msCSCCollectDataROM;;") 0))
					(juanObj (objGetObjByID (msnGetData missionObj 'juanID)))
					)
					(rpgCharacterChangeRel &unidJuanCarlos; 'aid)
					(shpCancelOrders juanObj)
					(shpOrder juanObj 'gate)
					
					;	Clear the character screen
					(rpgCharacterSetScreen &unidJuanCarlos; Nil)
					
					(msnSetData missionObj 'status 'leaving)
					)
			</OnJuanLeaves>

			<OnReward>
				(commFleet_GiveReward gSource)
			</OnReward>
		</Events>

		<Language>
			<Text id="Name">
				"Collect data ROM"
			</Text>
			<Text id="Summary">
				(cat
					"Your mission is to rendezvous with a nearby freighter and collect a data ROM.\n\n"

					"System: " (sysGetName) "\n"
					"Payment: " (fmtCurrency 'credit (msnGetData gSource 'reward))
					)
			</Text>
			<Text id="Intro">
				(cat
					"The XO walks up to you.\n\n"

					"\"Good to see you pilot. We've got a mission for you.\""
					)
			</Text>
			<Text id="Briefing">
				(cat
					"\"We need you to rendezvous and dock with a freighter a few light-minutes away. "
					"Pick up a data ROM and bring it back here safely. Understood?\""
					)
			</Text>
			<Text id="AcceptReply">
				"\"Good luck, %name%!\""
			</Text>
			<Text id="DeclineReply">
				"\"Get the hell out of here then!\""
			</Text>

			<Text id="InProgress">
				"\"What is your major malfunction!? Get back out there and complete your mission!\""
			</Text>
			<Text id="FailureDebrief">
				"\"You screwed that mission all the way to Sol and back. You better hit the sims, pilot!\""
			</Text>
			<Text id="SuccessDebrief">
				"\"Nice work! The data on this ROM is very important for the admiral and the Fleet.\""
			</Text>
			<Text id="JuanCarlosMeeting">
				(list
					{
						desc: (cat
							"\"We do not have much time, friend. I have a ROM with information, "
							"you know what I am saying? Take it back to the carrier; but watch for "
							"the Ares&mdash;they are looking for it too!\""
							)
						}
					{
						desc: (cat
							"As you talk, a shrill alarm drowns out the conversation.\n\n"
							"\"Ah, I see that we are late. Quick, take this ROM back to the carrier; "
							"I will hold them off here! Maybe we will meet again, no? Adi&#xF3;s!\""
							)

						nextPane: 'forceUndock
							
						nextCode: 
							(lambda ()
								(typFireEvent &msCSCCollectDataROM; 'OnAresAttack)
								)
						}
					)
			</Text>
			<Text id="JuanCarlosThanks">
				(list
					{
						desc: (cat
							"\"You got good weapons on your ship, compadre! Thank you for helping me out; "
							"but now you have to get that data back to the Fleet. The ROM has experimental "
							"results from a secret project called Lamplighter&mdash;I do not know any more "
							"than that. All I know is that it is important. See you out there, friend!\""
							)
						nextPane: 'forceUndock
							
						nextCode: 
							(lambda ()
								(typFireEvent &msCSCCollectDataROM; 'OnJuanLeaves)
								)
						}
					)

			</Text>
		</Language>
	</MissionType>


<!-- SHIP CLASSES -->
	
	<Type UNID="&unidJuanCarlos;">
		<StaticData>
			<Data id="MissionAttribute">"juanCarlosMission"</Data>
			<Data id="Name">"Juan Carlos"</Data>
			<Data id="Sovereign">&svCommonwealth;</Data>
		</StaticData>

		<Events>
			<OnCharacterCanBeMet>
				(switch
					(shpIsRadioactive gPlayerShip)
						(typTranslate &unidJuanCarlos; 'RefuseRadioactive)

					(objIsUnderAttack gSource)
						(typTranslate &unidJuanCarlos; 'RefuseUnderAttack)

					(objIsUnderAttack gSource)
						(typTranslate &unidJuanCarlos; 'RefusePlayerUnderAttack)

					True
					)
			</OnCharacterCanBeMet>

			<OnGlobalSystemStopped>
				(rpgCharacterAscend &unidJuanCarlos;)
			</OnGlobalSystemStopped>
		</Events>

		<Language>
			<Text id="RefuseRadioactive">
				"\"Mierda&mdash;you're glowing! I cannot help you; get back to the carrier!\""
			</Text>
			<Text id="RefuseUnderAttack">
				"\"No time to talk, compadre: I've got a fight on my hands!\""
			</Text>
			<Text id="RefusePlayerUnderAttack">
				"\"No time to talk, compadre: you have a fight on your hands!\""
			</Text>
		</Language>
	</Type>

	<!-- Juan Carlos's EI500 Freighter -->

	<ShipClass UNID="&scEI500JuanCarlos;"
			manufacturer=		"Earth Industries"
			class=				"EI500"
			type=				"freighter"

			attributes=			"juanCarlos"
			character=			"&unidJuanCarlos;"

			mass=				"150"
			cargoSpace=			"200"
			thrustRatio=		"2.0"
			maxSpeed=			"18"

			leavesWreck=		"75"

			dockingPorts=		"4"			
			dockScreen=			"&dsRPGCharacterDefault;"
			>

		<Armor>
			<ArmorSection start="315" span="90" armorID="&itAdvancedCeralloyArmor;" areaSet="0,2" />
			<ArmorSection start="225" span="90" armorID="&itAdvancedCeralloyArmor;" areaSet="3,4" />
			<ArmorSection start="135" span="90" armorID="&itAdvancedCeralloyArmor;" areaSet="1,6" />
			<ArmorSection start="45"  span="90" armorID="&itAdvancedCeralloyArmor;" areaSet="7,13" />
		</Armor>

		<Devices>
			<Device deviceID="&itOmniParticleCannon;"/>
			<Device deviceID="&itR1Deflector;"/>
			<Device deviceID="&itArmorRepairDevice;"/>
			<Device deviceID="&itMnemonicProcessor;"/>
			<Device deviceID="&itTritiumPropulsionUpgrade;"/>
			<Device deviceID="&it100MWReactor;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"4.5"
			rotationAccel=		"0.5"
			/>

		<Items>
			<Item count="5d12" item="&itHeliumAssembly;"/>
			<Lookup count="1d3" table="&trConsumables2;"/>
			<Lookup count="1"	table="&trMinorItem2;"/>
		</Items>

		<Image imageID="&rsEI500FreighterHD;" imageX="0" imageY="0" imageWidth="64" imageHeight="64" rotationCount="120"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="144"	posRadius="28"	posZ="0"	rotation="180"/>
			<Effect type="thrustMain"		posAngle="-144"	posRadius="28"	posZ="0"	rotation="180"/>
		</Effects>

		<Names definiteArticle="true">freighter Forking Paths</Names>

		<AISettings
			fireRateAdj=		"10"
			fireAccuracy=		"95"
			perception=			"4"
			/>

		<Language>
			<Text id="FirstMeetingIntro">
				(cat
					"As you step out of the airlock you are met by a man in a flight suit. "
					"He rubs the top of his shaved head as he scrutinizes you. After a few "
					"moments, he reaches out to shake your hand:\n\n"

					(switch
						(= (objGetType gPlayerShip) &scEI100XPlayer;)
							"\"That is a nice ship you've got, friend. I am Juan Carlos Uribe y V&aacute;zquez, at your service, and the Forking Paths is my ship; she is not so well armed as yours, maybe, but you are going to more dangerous places, no?\""

						"\"Welcome, friend. My name is Juan Carlos Uribe y V&aacute;zquez and the Forking Paths is my ship.\""
						)
					)
			</Text>

			<Text id="MeetingIntro">
				(cat
					"The airlock opens and you see Juan Carlos dressed in a flight suit.\n\n"

					"\"Good to see you, %name%!\""
					)
			</Text>

			<Text id="NoMissions">
				(cat
					"The airlock refuses to open."
					)
			</Text>
		</Language>
	</ShipClass>

</TranscendenceModule>
